/*--------------------------------------------*//*Add blank space in Excel to row 1 for:      *//*  CR Manager                                *//*  Secondary_Watchlist Char 5                *//*  Watchlist Char 5                          *//*--------------------------------------------*//*Format date fields as dates, if required.   *//*--------------------------------------------*//*Inputs:*//*  - CMS list (Excel)*//*  - RCMS CIGS*//*  - manual reviews*//*      - TCE > 10m*//*      - invoice discounting  > 5m*//*      - MAF > 5m*//*  - BLAST*//*      - L6M increase >500k*//*      - L12M review*//*  - EH/WL (report or GDW?)*//*23-May-2016:                                                *//*   For decision tree:                                       *//*      Use the logic coded in:                               *//*          C:\ar\output\Logic 4a for SGB PRR Reporting.xlsx  *//*Changes for 24-Jun-2016:*//*1.*//*Overdue calc:*//*if *//*  Auto review flag*//*,Watchlist,*//*,<=E35*//*          = 1 day*//*Manual review flag *//*          = 45 days' grace*//*2.*//*Set dates as per parameter workbook.*//*3.*//*Create/track history/month-key file: date set, date source*//* Domain values: *//*COMMON_002_proc_Freq_L4a_vars.sas*//*Code-tidy version:*//*  COMM_CIGS_002a.sas*//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*PARAMETERS:*//*---s010.010: Control parameters*//*---sParms:*//*%let SchedType = 201511;*//*%let SchedType = 201512;*//*%let SchedType = 201601;*//*%let SchedType = 201603;*//*%let SchedType = 201604;*//*%let SchedType = 201605;*//*%let SchedType = 201606;*/%let SchedType = 201701;/*%let CurrMK_Date = %BQUOTE('2015-11-30');*//*%let CurrMK_Date = %BQUOTE('2015-12-31');*//*%let CurrMK_Date = %BQUOTE('2016-01-31');*//*%let CurrMK_Date = %BQUOTE('2016-05-31');*//*%let CurrMK_Date = %BQUOTE('2016-06-30');*/%let CurrMK_Date = %BQUOTE('2017-01-31');%let Hist_MthZero = 201606;%let TestMode = Y; /* Y = include test data; N = prod data only */%let ThresholdAmt = 250000; /* 250k */%let MK = &SchedType.;/*Nov-2015 extract file:*/%let EXTR_201511 = C:\ar\output\SCODR001 - CMS Overdue Reviews-201511.xls;/*Dec-2015 extract file:*/%let EXTR_201512 = C:\ar\output\SCODR001 - CMS Overdue Reviews-201512.xls;/*Jan-2016 extract file:*/%let EXTR_201601 = C:\ar\output\Full  SCODR001 - CMS Overdue Reviews-201601.xls;/*Feb-2016 extract file:*/%let EXTR_201602 = c:\ar\output\SCODR001 - CMS Overdue Reviews-201602.xls;/*Mar-2016 extract file:*/%let EXTR_201603 = c:\ar\output\SCODR001 - CMS Overdue Reviews-201603.xls;/*Apr-2016 extract file:*/%let EXTR_201604 = c:\ar\output\SCODR001 - CMS Overdue Reviews-201604.xls;/*May-2016 extract file:*/%let EXTR_201605 = c:\ar\output\SCODR001 - CMS Overdue Reviews-201605.xls;/*Jun-2016 extract file:*/%let EXTR_201606 = c:\ar\output\SCODR001 - CMS Overdue Reviews-201606.xls;/*Jul-2016 extract file:*/%let EXTR_201607 = C:\ar\output\SCODR001 - CMS Overdue Reviews-201607.xls;/*Jul-2016 extract file:*/%let EXTR_201701 = C:\ar\output\SCODR001 - CMS Overdue Reviews-201701.xls;%let ExtractFN = &&EXTR_&MK..;%put ExtractFN = &ExtractFN.;/*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*    x x  x x  x x  x x  x x  x x  x x  x x  x x  x x    *//*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*   ~                                                ~   *//*              {   End of code block   }                 *//*  M=<================= oooOooo ====================>=M  *//*                                                        *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*Formats and macro variables for processing:*//*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*---s020.010: Macro variables - calculate dates*/data COMMON.x;    Format        MainMK $6.        dMainMK date9.        dL6M date9.        dL12M date9.        dEOM date9.        dL12M_EOM date9.        /* calendar month, to calc business EOM */        M0 $6.        /* current business month */        M1 $6.        M2 $6.        M3 $6.        M4 $6.        M5 $6.        M6 $6.        M7 $6.        M8 $6.        M9 $6.        M10 $6.        M11 $6.        M12 $6.        M13 $6.        tL6M_dmy $11.        tL12M_dmy $11.        tL12M_dmyANSI $10.        tL12M_dmyANSIEOM $10.        tFileNameMK $7.        tMonthEndMK $8.        tCurrM_dmy $11.        tARD $9.        tARDGAR $9.        tPRRTimestamp $10.        CurrMK $6.        BusMth $6.        tEOMCurrMK $9.        ;/*  BusMth = put(INTNX("MONTH", "&SYSDATE9."d, -1), yymmn6.);*/    BusMth = &SchedType.;    MainMK = BusMth;    dMainMK = input(BusMth, yymmn6.);/*  MainMK = "&MainMonthKey.";  *//*  dMainMK = input("&MainMonthKey.", yymmn6.);*/    dL6M = INTNX("MONTH", dMainMK, -5);    dL12M = INTNX("MONTH", dMainMK, -11);    dEOM = INTNX("MONTH", dMainMK, 1) -1;    M0 = put(INTNX("MONTH", dMainMK,  1 ), yymmn6.);    M1 = put(               dMainMK, yymmn6.);    M2 = put(INTNX("MONTH", dMainMK, -1 ), yymmn6.);    M3 = put(INTNX("MONTH", dMainMK, -2 ), yymmn6.);    M4 = put(INTNX("MONTH", dMainMK, -3 ), yymmn6.);    M5 = put(INTNX("MONTH", dMainMK, -4 ), yymmn6.);    M6 = put(INTNX("MONTH", dMainMK, -5 ), yymmn6.);    M7 = put(INTNX("MONTH", dMainMK, -6 ), yymmn6.);    M8 = put(INTNX("MONTH", dMainMK, -7 ), yymmn6.);    M9 = put(INTNX("MONTH", dMainMK, -8 ), yymmn6.);    M10= put(INTNX("MONTH", dMainMK, -9 ), yymmn6.);    M11= put(INTNX("MONTH", dMainMK, -10), yymmn6.);    M12= put(INTNX("MONTH", dMainMK, -11), yymmn6.);    M13= put(INTNX("MONTH", dMainMK, -12), yymmn6.);    dL12M_EOM = INTNX("MONTH", dMainMK, -10) - 1;    tL6M_dmy = put(dL6M, date11.);    tL6M_dmyANSI = put(dL6M, yymmddd10.);    tL12M_dmy = put(dL12M, date11.);    tL12M_dmyANSI = put(dL12M, yymmddd10.);    tL12M_dmyANSIEOM = put(dL12M_EOM, yymmddd10.);    tCurrM_dmy = put(dEOM, date11.);    tFileNameMK = put(INTNX("MONTH", dMainMK, 1 ), monyy7.);    tFileNameMK = substr(tFileNameMK, 1, 1)                    ||                  lowcase(substr(tFileNameMK,2));    tARD = put(INTNX("MONTH", dMainMK, 5 )-1, date9.);    tARDGAR = put(INTNX("MONTH", dMainMK, 11 )-1, date9.);    tMonthEndMK = substr(put(dMainMK, date11.), 4);    tMonthEndMK = substr(tMonthEndMK, 1, 1)                    ||                  lowcase(substr(tMonthEndMK,2));    tPRRTimestamp = put(INTNX("MONTH", dMainMK, 1 ) + 13, ddmmyys10.);    tEOMCurrMK = put(dEOM, date9.);    CurrMK = M1;run;/*---s020.020: Macro variables - print to log window*/proc print data = COMMON.x (obs=5); run;/*---s020.030: List all the date fields (PROC CONTENTS)*/proc contents    Data = COMMON.x    out = COMMON.x2    noprint    ;quit;/*---s020.040: Keep the text-formatted variable names */data COMMON.x3;    set COMMON.x2;    if TYPE = 2; /* text variables */    keep        Name        ;run;/*---s020.050: Store the date field names as a set of macro variables*/data _null_;    set COMMON.x3 end = EOF;    call symputx(cats("var", _N_), NAME);    if EOF then do;        call symputx("VarTot", _N_);    end;run;/*options mprint mlogic symbolgen;*//*options nomprint nomlogic nosymbolgen;*//*---s020.060: Define macro Global_VAR - declare macro variables as global*/%macro Global_VAR;            %do i = 1 %to &VarTot.;                %let TheVar = &&var&i..;                %global &TheVar.;            %end;%mend;/*---s020.070: Define macro Set_VAR - store the datefield names in memory as SAS macro variables*/%macro Set_VAR;    data _null_;        set COMMON.x;            %do i = 1 %to &VarTot.;                %let TheVar = &&var&i..;                call symputx("&TheVar.", &TheVar.);            %end;    run;    %global TheMK;    %let TheMK = %BQUOTE('&m1.');    %global qL6M_dmy;    %let qL6M_dmy = %BQUOTE('&tL6M_dmy.');    %global qtL6M_dmyANSI;    %let qtL6M_dmyANSI = %BQUOTE('&tL6M_dmyANSI.');    %global qL12M_dmy;    %let qL12M_dmy = %BQUOTE('&tL12M_dmy.');    %global qtL12M_dmyANSI;    %let qtL12M_dmyANSI = %BQUOTE('&tL12M_dmyANSI.');    %global qtL12M_dmyANSIEOM;    %let qtL12M_dmyANSIEOM = %BQUOTE('&tL12M_dmyANSIEOM.');    %global qEOM;    %let qEOM = %BQUOTE('&tCurrM_dmy.');    %global dmARD;    %let dmARD = %BQUOTE('&tARD.');    %global dmARDGAR;    %let dmARDGAR = %BQUOTE('&tARDGAR.');    %global qDayEOM;    %let qDayEOM = %BQUOTE('&tEOMCurrMK.');%mend;/*---s020.080: Define macro Display_VAR - display the macro variable values in the log*/%macro Display_VAR;    %do i = 1 %to &VarTot.;        %let TheVar = &&var&i..;        %put &i.. &TheVar. = &&&TheVar.;    %end;    %put ;    %put Quoted macro variables:;    %put TheMK = &TheMK.;    %put qL6M_dmy = &qL6M_dmy.;    %put qEOM = &qEOM.;    %put dmARD = &tARD.;    %put dmARDGAR = &tARDGAR.;%mend;/*---s020.090: Run macro Global_VAR*/%Global_VAR/*---s020.100: Run macro Set_VAR*/%Set_VAR/*---s020.110: Run macro Display_VAR*/%Display_VAR;/*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*    x x  x x  x x  x x  x x  x x  x x  x x  x x  x x    *//*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*   ~                                                ~   *//*              {   End of code block   }                 *//*  M=<================= oooOooo ====================>=M  *//*                                                        *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*FORMATS:*//*---s030.010: ANZSICs as FORMATs: LIBNAMEs and workbooks*//*ANZSIC: Look:*/%let ANZSICLIB = &TheLib.;%let ASCOLIB = &TheLib.;%let ANZSICWB = C:\ar\refs\1292.0.55.002_anzsic 2006 - codes and titles.xls;/*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*ANZSIC List:    *//*---s030.020: ANZSICs as FORMATs: Read in the ANZSICs*/    libname XL  excel "&ANZSICWB.";    data &ANZSICLIB..ANZSIC1993;        Format            ClassList 4#            ;        set XL."ANZSIC1993$"n;        if ClassDesc ne "";        if ClassDesc ne " ";        if ClassDesc ne "xxx";        ClassList = substr(Class1993, 1, 4);        keep            ClassList            Division1993            Subdivision1993            Group1993            Class1993            ;    run;    libname XL clear;/*ANZSIC formats:*//*---s030.030: ANZSICs as FORMATs: define the FORMATs*/        %include "&SCPath.ANZSIC_Classes.sas";/*        ASCO List:*//*---s030.040: ANZSICs as FORMATs: Read in the ASCOs: DIV*/    libname XL  excel "&ANZSICWB.";    data &ASCOLIB..List_ASCO;    /*    for worksheet*/        set XL."ASCO_Ref$"n;        if ClassUnique ne "";    run;/*---s030.050: ANZSICs as FORMATs: Read in the ASCOs: SUBDIV*/    data &ASCOLIB..List_ASCO_SUBDIV;        set XL."ASCO_Sub_List_Ref$"n;        Format            ASCO_SUB_Desc $100.            ;        ASCO_SUB_Desc = catx(" - ", TwoDigit_ASCO_Subdivision, Subdivision_Description);    run;    libname XL clear;/*ASCO formats:*//*---s030.060: ANZSICs as FORMATs: ASCO subpop*/        %Format_Subpop(            INLIB=&ASCOLIB.,            INDSN=List_ASCO,            FMTLIB=&ASCOLIB.,            FMTDSN=FMT_List_ASCO0,            FMTNAME=FASCO0x,            FMTTYPE=N,            KEYCOL=ASCO_Num,            OTHER=            )/*---s030.070: ANZSICs as FORMATs: ASCO class FORMAT*/        %Format_Classing(            INLIB=&ASCOLIB.,            INDSN=List_ASCO,            FMTLIB=&ASCOLIB.,            FMTDSN=FMT_List_ASCO1,            FMTNAME=FASCO1x,            FMTTYPE=N,            KEYCOL=ASCO_Num,            TAGCOL=ASCO_Class,            OTHER=            )/*---s030.080: ANZSICs as FORMATs: ASCO 2-digit FORMAT*/        %Format_Classing(            INLIB=&ASCOLIB.,            INDSN=List_ASCO,            FMTLIB=&ASCOLIB.,            FMTDSN=FMT_List_ASCO2,            FMTNAME=FASCO2x,            FMTTYPE=N,            KEYCOL=ASCO_Num,            TAGCOL=TwoDigitASCO,            OTHER=            )/*---s030.090: ANZSICs as FORMATs: ASCO 1-digit FORMAT*/        %Format_Classing(            INLIB=&ASCOLIB.,            INDSN=List_ASCO,            FMTLIB=&ASCOLIB.,            FMTDSN=FMT_List_ASCO3,            FMTNAME=FASCO3x,            FMTTYPE=N,            KEYCOL=ASCO_Num,            TAGCOL=OneDigitASCO,            OTHER=            )        /*ASCO Div and Subdiv descriptions:*//*---s030.100: ANZSICs as FORMATs: ASCO 2-digit subpop*/        %Format_Subpop(            INLIB=&ASCOLIB.,            INDSN=List_ASCO_SUBDIV,            FMTLIB=&ASCOLIB.,            FMTDSN=FMT_ASCO_SUB_Desc,            FMTNAME=FASDD,            FMTTYPE=N,            KEYCOL=TwoDigit_ASCO_Subdivision,            OTHER=            )/*---s030.110: ANZSICs as FORMATs: ASCO 2-digit SUBDIV classing*/        %Format_Classing(            INLIB=&ASCOLIB.,            INDSN=List_ASCO_SUBDIV,            FMTLIB=&ASCOLIB.,            FMTDSN=FMT_ASCO_SUB_Desc1,            FMTNAME=FASDDA,            FMTTYPE=N,            KEYCOL=TwoDigit_ASCO_Subdivision,            TAGCOL=ASCO_SUB_Desc,            OTHER=            )/*---s030.110: ANZSICs as FORMATs: ASCO 2-digit DIV classing*/        %Format_Classing(            INLIB=&ASCOLIB.,            INDSN=List_ASCO_SUBDIV,            FMTLIB=&ASCOLIB.,            FMTDSN=FMT_ASCO_SUB_Desc2,            FMTNAME=FASDDB,            FMTTYPE=N,            KEYCOL=TwoDigit_ASCO_Subdivision,            TAGCOL=Division_Description,            OTHER=            )/*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*    x x  x x  x x  x x  x x  x x  x x  x x  x x  x x    *//*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*   ~                                                ~   *//*              {   End of code block   }                 *//*  M=<================= oooOooo ====================>=M  *//*                                                        *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*---s040.010: Confirm RCMS data is for current month:*/proc sql;connect to ODBC (user="&ORAUSRID." pw="&ORAPWD." DSN ="EWP1ARISK");create TABLE COMMON.RCMS_MaxMK as select     *  from connection to ODBC (        select             max(Month_Key) As Max_Month_Key        from            RCMS_MTHLY_CUST_RESULTS);quit;/*---s040.020: Display RCMS month key*/proc print    Data = COMMON.RCMS_MaxMK        ;run;/*Make a list of XXX and store them in memory*//*---s040.030: Store RCMS month key in memory*/data _null_;    set COMMON.RCMS_MaxMK end = EOF;    call symputx("RCMSMMK", compress(Max_Month_Key));run;%put RCMSMMK = &RCMSMMK.;/*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*    x x  x x  x x  x x  x x  x x  x x  x x  x x  x x    *//*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*   ~                                                ~   *//*              {   End of code block   }                 *//*  M=<================= oooOooo ====================>=M  *//*                                                        *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*---s050.001: Collect the data:*//*Testlab:*//*libname XL EXCEL "C:\ar\output\SCODR001 - CMS Overdue Reviews-201605 - CopyTest.xls";*//*data work.x;*//*    set XL."Overdue Review Full Listing$"n;*//*  if F1 > 0;*//*  rename*//*      CUST_GRP_ID = Group_ID*//*      ;*//*run;*//*libname XL clear;*//*proc contents *//*    data = work.x; *//*quit;*//*Secondary_Watchlist Num 8   *//*Watchlist Num 8             *//*libname XL EXCEL "C:\ar\output\SCODR001 - CMS Overdue Reviews-201605 - CopyTest.xls"*//*  MIXED = NO*//*  ;*//*data work.x2;*//*    set XL."Overdue Review Full Listing$"n*//*          (*//*              dbsastype = (*//*                      Secondary_Watchlist = 'CHAR(5)'*//*                      Watchlist = 'CHAR(5)'*//*                          )*//*          )*//*          ;*//*  if F1 > 0;*//*  rename*//*      CUST_GRP_ID = Group_ID*//*      ;*//*run;*//*libname XL clear;*//*proc contents *//*    data = work.x2; *//*quit;*//*dbsastype: char, but empty.*//*mixed =yes: numeric*//*Secondary_Watchlist Char 5 *//*Watchlist Char 5 *//*Both options together:*//*Secondary_Watchlist Char 5 *//*Watchlist Char 5 *//*proc freq data = work.x2;*//*  table Secondary_Watchlist / nocol norow nopercent missing;*//*  table Watchlist / nocol norow nopercent missing;*//*quit;*//*s/b 345:                          *//*Watchlist                         *//*Watchlist Frequency   Cumulative  *//*                      Frequency   *//*          25879       25879       *//*Joanne add this : Jul-2016 extract file:*/%let EXTR_201701 = C:\ar\output\SCODR001 - CMS Overdue Reviews-201701.xls;%let ExtractFN = &&EXTR_&MK..;%put ExtractFN = &ExtractFN.;/*---s050.010: Read in the current month's CMS report*/libname XL EXCEL "&ExtractFN.";data COMMON.SBG_AR_CMS_RFL_&MK.;    set XL."Overdue Review Full Listing$"n;    if F1 > 0;    rename        CUST_GRP_ID = Group_ID        ;run;data COMMON.SBG_INFILE_TotalGM_&MK.;    set XL."Total Group Managed$"n;    if F1 ne .;run;libname XL clear;proc freq data = COMMON.SBG_AR_CMS_RFL_&MK.;    table Secondary_Watchlist / nocol norow nopercent missing;    table Watchlist / nocol norow nopercent missing;quit;/*---s050.020: Get RCMS data*/proc sql;connect to ODBC (user="&ORAUSRID." pw="&ORAPWD." DSN ="EWP1ARISK");create TABLE COMMON.SBG_AR_RCMS_&RCMSMMK. as select     *  from connection to ODBC (        select/*           distinct */             Month_Key            ,case                when (CUST_CONNECTION_ID = 'Z'                        or                      CUST_CONNECTION_ID = ''                        ) then 0                else cast(CUST_CONNECTION_ID as integer)            end As CMS_Group_ID            ,cast(CUSTOMER_ID_GCIS as integer) as GCIS_Key            ,CONN_GOOD_STNDG_INT_FLG  as CIGS            ,CUST_GOOD_STNDG_OUTCOME_NAME as CIGS_Outcome            ,CUST_GOOD_STNDG_INT_NODE_ID as CIGS_Node_ID        from            RCMS_MTHLY_CUST_RESULTS        where /*Month_Key = '201511'        and*/ BANK_CODE = 'SGB'        /* remove non-numeric values: *//*      and CUST_CONNECTION_ID ^= 'Z'*//*      and CUST_CONNECTION_ID ^= ''*/        /* keep rows with (Group) data: *//*      and cast(CUST_CONNECTION_ID AS INTEGER) > 0*/);quit;/*Is Credit Account table ready?*/proc sql;connect to ODBC (user="&ORAUSRID." pw="&ORAPWD." DSN ="aa_SGB");create TABLE COMMON.zLook_SBG_CRACCT_&MK. as    select *  from connection to ODBC     (select            count(*) as Num_Rows_&MK.          from GRPCRED.e05903_CRE_Acct as A         where cast(a.ProcessDate as date) = date &CurrMK_Date.     );quit;proc print    data = COMMON.zLook_SBG_CRACCT_&MK.        ;run;/*---s050.030: Collect Manual Review: GT10m data:*//*GT10M:*/proc sql;connect to ODBC (user="&ORAUSRID." pw="&ORAPWD." DSN ="aa_SGB");create TABLE COMMON.SBG_AR_GT10M_&MK. as    select *  from connection to ODBC     (select             aa.Group_ID            ,aa.Bus_TCE    from (            select                 a.Group_ID/*              ,sum(Exp_Amt) as Total_TCE*/                ,sum(                    case                        when (a.Product_Market = 'Com') then a.Exp_Amt                        else 0                    End                                                ) as CommProd_TCE                ,sum(                    case                        when (a.Product_Market = 'Ret'                                and                             a.Acct_Type = 'Auto Finance Leases'                                ) then a.Exp_Amt                        else 0                    End                                                ) as AutoF_TCE                ,CommProd_TCE + AutoF_TCE as Bus_TCE              from GRPCRED.e05903_CRE_Acct as A         where cast(a.ProcessDate as date) = date &CurrMK_Date.           and a.Group_ID <> ''          Group by                a.Group_ID         having                Bus_TCE > 10000000        ) AA     );    create index Group_ID on COMMON.SBG_AR_GT10M_&MK.(Group_ID);quit;%put CurrMK_Date = &CurrMK_Date.;/*---s050.040: Business TCE per Group:*/proc sql;connect to ODBC (user="&ORAUSRID." pw="&ORAPWD." DSN ="aa_SGB");create TABLE COMMON.SBG_AR_BusTCE_&MK. as    select *  from connection to ODBC     (select             aa.Group_ID            ,aa.Bus_TCE            ,case                when (aa.Bus_TCE < &ThresholdAmt.) then 'Y'                Else 'N'            end As BusTCE_LT250k_Flag    from (            select                 a.Group_ID/*              ,sum(Exp_Amt) as Total_TCE*/                ,sum(                    case                        when (a.Product_Market = 'Com') then a.Exp_Amt                        else 0                    End                                                ) as CommProd_TCE                ,sum(                    case                        when (a.Product_Market = 'Ret'                                and                             a.Acct_Type = 'Auto Finance Leases'                                ) then a.Exp_Amt                        else 0                    End                                                ) as AutoF_TCE                ,CommProd_TCE + AutoF_TCE as Bus_TCE              from GRPCRED.e05903_CRE_Acct as A         where cast(a.ProcessDate as date) = date &CurrMK_Date.           and a.Group_ID <> ''          Group by                a.Group_ID        ) AA     );    create index Group_ID on COMMON.SBG_AR_BusTCE_&MK.(Group_ID);quit;/*Invoice Finance:*//*called Invoice Discounting:*//* = Scottish South Pacific:*//*---s010.110: Connection-level: invoice finance accounts (=invoice discounting)*//*InvDisc:*//*Invoice Discounting: >$5m*//*Invoice Discounting Plus: >$500k*//**//*EF:*//*Master Asset Facility (MAF): = bulk limit.*//*Multiple Option Facility (MOF): not a bulk limit.*//*21552 / SGB Master Asset Finance (MAF)*//*22302 / SGB SGB-Invoice Discounting*//*22303 / SGB SGB-Invoice Discounting Plus*//*---s050.050: Invoice Discounting - Account-level*/proc sql;connect to ODBC (user="&ORAUSRID." pw="&ORAPWD." DSN ="aa_SGB");create TABLE COMMON.SBG_AR_INVDISC_pre_&MK. as select    * from connection to ODBC (     select          a.Group_ID         ,a.Acct_Key         ,a.Exp_Amt         ,a.Product_Market         ,a.Acct_Type         ,case            /* InvDisc plus */            when (                   a.Acct_Type = 'SPF SDP'                   and                   a.Exp_Amt > 500000                ) then 'Y'            /* InvDisc */            when (                   a.Acct_Type like 'SPF%'                   and                   a.Exp_Amt > 5000000                ) then 'Y'            Else 'N'        end As InvoiceFinance_Flag      from GRPCRED.e05903_CRE_Acct as A    where cast(a.ProcessDate as date) = date &CurrMK_Date.      and a.Group_ID <> ''      /* invoice discounting: old rule */      and substr(a.Acct_Key, 1, 4) = 'SSPF'      /* current month */      and cast(a.ProcessDate as date) = date &CurrMK_Date.     );quit;/*---s050.060: Multi-asset finance - Account-level*/proc sql;connect to ODBC (user="&ORAUSRID." pw="&ORAPWD." DSN ="aa_SGB");create TABLE COMMON.SBG_AR_MAF_pre_&MK. as    select *  from connection to ODBC     (select          a.Group_ID         ,a.Acct_Key         ,a.Exp_Amt         ,a.Product_Market         ,a.Acct_Type    from GRPCRED.e05903_CRE_Acct a    where Acct_Key like 'SLMTMAF%'      and cast(a.ProcessDate as date) = date &CurrMK_Date.     );quit;/*---s050.070: Collect Watchlist data:*//*F027:*//*Watchlist:*/proc sql;connect to ODBC (user="&ORAUSRID." pw="&ORAPWD." DSN ="aa_SGB");create TABLE COMMON.SBG_AR_WL_&MK. as select    * from connection to ODBC (            select                 aa.Group_ID                ,bb.Max_WatchlistDate/*              ,bb.F027_Months_Since_WL*/           from (select                 a.Group_ID                ,sum(                    case                        when (a.Product_Market = 'Com') then a.Exp_Amt                        else 0                    End                    +                    case                        when (a.Product_Market = 'Ret'                                and                             a.Acct_Type = 'Auto Finance Leases'                                ) then a.Exp_Amt                        else 0                    End                    ) as Bus_TCE                ,sum(                        case                        when (Exp_Amt is null) then 0                        Else: Exp_Amt                        End                    ) as Connection_TCE              from GRPCRED.e05903_CRE_Acct as A         where cast(a.ProcessDate as date) = date &CurrMK_Date.           and a.Group_ID <> ''          Group by                a.Group_ID         having                Bus_TCE > 1        ) AA        ,( select                 b.CMS_ID as Group_ID/*              ,max(*//*                      (case*//*                          when (b.WatchlistDate is null) then -1 *//*                          else (*//*                                  date &CurrMK_Date.*//*                                  -*//*                                  cast(b.WatchlistDate as DATE)*//*                                  ) / 30*//*                          end*//*                      )*//*                  ) as F027_Months_Since_WL*/                ,max(b.WatchlistDate) as Max_WatchlistDate            from ZBST_Credit_Appln b            where (Not b.WatchlistDate Is Null)              and cast(b.ApplnDate as DATE) >= DATE &qtL12M_dmyANSIEOM./*                                          between *//*                                      add_months(&CurrMK_Date., -1) + 1*//*                                      and*//*                                      date &CurrMK_Date.*/           Group by                Group_ID/*          having *//*                  Max_WatchlistDate > 0*//*                  and*//*                  F027_Months_Since_WL ^= -1*/        ) BB    where cast(substr(aa.Group_ID, 2, 15) as numeric(15,0)) = bb.Group_ID/*    and bb.Max_WatchlistDate > 0 */     );    create index Group_ID on COMMON.SBG_AR_WL_&MK.(Group_ID);quit;/*---s050.080: Collect E-H grade data:*//*---F028:*//*-----------------------------------------------------------------------------------*//*E-H flag:*/proc sql;connect to ODBC (user="&ORAUSRID." pw="&ORAPWD." DSN ="aa_SGB");create TABLE COMMON.SBG_AR_EH_&MK. as select    * from connection to ODBC     (select distinct b.Group_ID            ,'Y' as F028_Conn_EH_Flag      from GRPCRED.e05903_CRE_Acct b/*      where substr(b.UPD_WBC_PD_SYS, 1, 1) in (*/      where substr(b.WBC_PD, 1, 1) in (                                'E',                                'F',                                'G',                                'H'                                )        /* current month *//*      and processdate = date-extract(day From date)*/         and cast(b.ProcessDate as date) =/*                                      between *//*                                      add_months(&MKQ., -1) + 1*//*                                      and*/                                        date &CurrMK_Date.     );    create index Group_ID on COMMON.SBG_AR_EH_&MK.(Group_ID);quit;/*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*L4a logic:*//*---s050.090: BLAST increase L6M:*/proc sql;connect to ODBC (user="&ORAUSRID." pw="&ORAPWD." DSN ="aa_SGB");create TABLE COMMON.SBG_ARincr_BLAST_&MK. as select     *  from connection to ODBC (        select             appl.Credit_Appln_ID            ,appl.Appln_type            ,appl.ApplnDate            ,appl.CMS_ID            ,appl.Group_Name            ,appl.Decision            ,appl.DecisionDate            ,appl.SettleDate            ,appl.LastReview            ,appl.ProposedReview_Date            ,appl.CurrentReview_Date            ,borr.Borrower_ID            ,fac.Facility_ID            /* Amounts in 000s: */            ,fac.Current_Limit            ,fac.Proposed_Limit            ,ft.Retail            from             ZBST_Credit_Appln appl            ,ZBST_Facility fac            ,ZBST_Borrower borr            ,ZBST_Facility_Type   ft        where appl.To_Date = Date '2999-12-31'          and appl.CMS_ID > 0          and appl.ApplnDate_Date >= DATE &qtL6M_dmyANSI.          and (                    (                    /* Approved */                    appl.Decision = 'A'                    and                       appl.Appln_type in (                            /* new */                             'N'                            /* increase */                            ,'I'                            )                    )                )           and appl.Credit_Appln_ID = borr.Credit_Appln_ID           and borr.Borrower_Id = fac.Borrower_Id           and fac.Facility_Type_ID = ft.Facility_Type_ID           and fac.To_Date = DATE '2999-12-31'           and borr.To_Date = DATE '2999-12-31'           and ft.To_Date = DATE '2999-12-31'           and Proposed_Limit - fac.Current_Limit > 0           and ft.Retail = 'N'                                    );quit;/*---s050.100: BLAST review L12M:*/proc sql;connect to ODBC (user="&ORAUSRID." pw="&ORAPWD." DSN ="aa_SGB");create TABLE COMMON.SBG_ARrev_BLAST_&MK. as select     *  from connection to ODBC (        select             Credit_Appln_ID            ,Appln_type            ,ApplnDate            ,CMS_ID            ,Group_Name            ,Decision            ,DecisionDate            ,SettleDate            ,case                when (SettleDate is null) then DecisionDate                when (SettleDate > DecisionDate) then SettleDate                Else: DecisionDate             End              as FilterDate            ,LastReview            ,ProposedReview_Date            ,CurrentReview_Date        from            ZBST_Credit_Appln        where To_Date = Date '2999-12-31'          and CMS_ID > 0/*        and ApplnDate_Date >= DATE &qtL12M_dmyANSI.*/          and (                cast(DecisionDate as DATE) >= DATE &qtL12M_dmyANSI.                or                cast(SettleDate as DATE) >= DATE &qtL12M_dmyANSI.                )          and (                  (                    Appln_type = 'R'                    and                    /* Approved */                    Decision = 'A'                    )                ))    Order by         CMS_ID        ,FilterDate    ;quit;/*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*    x x  x x  x x  x x  x x  x x  x x  x x  x x  x x    *//*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*   ~                                                ~   *//*              {   End of code block   }                 *//*  M=<================= oooOooo ====================>=M  *//*                                                        *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*Caluclate and process:*//*---s060.010: Make a list of CMS Report Group IDs:*/proc sql;   create table COMMON.SBG_AR_CMS_RFL2_&MK. as     (select distinct Group_ID      from COMMON.SBG_AR_CMS_RFL_&MK.     );quit;/*---s060.020: Make a list of CMS Report Group IDs:*/%Format_Subpop(    INLIB=COMMON,    INDSN=SBG_AR_CMS_RFL2_&MK.,    FMTLIB=COMMON,    FMTDSN=FMT_SBG_AR_&MK.,    FMTNAME=FSBGAR,    FMTTYPE=C,    KEYCOL=Group_ID,    OTHER=    )/*---s060.030: Create RCMS "C"/"G" Group_ID:*/sasfile COMMON.SBG_AR_RCMS_&MK. load;data COMMON.SBG_AR_RCMS_G_&MK.(index=(Group_ID));    Format        Group_ID $16.        ;    set        COMMON.SBG_AR_RCMS_&MK.        ;/*  %SetSource*//*  %Source(Step=b)*/    Group_ID = "";    /* Remove empty rows */    if CMS_Group_ID ne .;    /* Create Group ID: */    if CMS_Group_ID > 0 then do;        Group_ID = cats("G", put(CMS_Group_ID, z15.));    end;    else do;        Group_ID = cats("C", put(GCIS_Key, z15.));    end;    /* filter to the 24k ASFR CMS list: */    if put(Group_ID, ? $FSBGAR.) eq "Y";        keep        Group_ID        CIGS        CIGS_Outcome        CIGS_Node_ID/*      DataLineage*/        ;run;sasfile COMMON.SBG_AR_RCMS_&MK. close;/*---s060.040: CIGS-Combo: Roll up to Group-level */sasfile COMMON.SBG_AR_RCMS_G_&MK. load;data COMMON.SBG_AR_RCMS_G2_&MK.;    set        COMMON.SBG_AR_RCMS_G_&MK.        ;    by Group_ID;/*  %Source(Step=c)*/    Format        CIGS_Combo $50.        CIGS_Outcome_Combo $200.        CIGS_Node_ID_Combo $100.        CIGS_Flag $1.        Combo_Count 8#        CIGS_Y_Count 8#        CIGS_All_Count 8#        Drvd_CIGS_Flag $1.        ;    if first.Group_ID then do;        CIGS_Combo = "";        CIGS_Outcome_Combo = "";        CIGS_Node_ID_Combo = "";        CIGS_Flag = "Y";        Combo_Count = 0;        CIGS_Y_Count = 0;        CIGS_All_Count = 0;    end;    if CIGS_Outcome = "Pass CIGS" then do;        CIGS_Y_Count = CIGS_Y_Count + 1;    end;    CIGS_All_Count = CIGS_All_Count + 1;    if CIGS_Outcome ^= "Pass CIGS" then do;            CIGS_Combo = cats(                     CIGS_Combo                    ,CIGS                    );            Combo_Count = Combo_Count + 1;            if index(CIGS_Outcome_Combo, cats(CIGS_Outcome)) eq 0 then do;                CIGS_Outcome_Combo = catx(                                "/"                                ,CIGS_Outcome_Combo                                ,CIGS_Outcome                                );            end;            if index(CIGS_Node_ID_Combo, cats(CIGS_Node_ID)) eq 0 then do;                CIGS_Node_ID_Combo = catx(                                "/"                                ,CIGS_Node_ID_Combo                                ,cats("x",CIGS_Node_ID)                                );            end;    end;    if index(CIGS_Combo, "N") gt 0        and       CIGS_Flag ne "N"        then do;        CIGS_Flag = "N";    end;    if last.Group_ID;    if CIGS_Y_Count = CIGS_All_Count then do;        Drvd_CIGS_Flag = "Y";    end;    else do;        Drvd_CIGS_Flag = "N";    end;    retain        CIGS_Combo        CIGS_Outcome_Combo        CIGS_Node_ID_Combo        CIGS_Flag        Combo_Count        CIGS_Y_Count        CIGS_All_Count        ;    keep        Group_ID        CIGS_Combo        CIGS_Outcome_Combo        CIGS_Node_ID_Combo        CIGS_Flag        Combo_Count        CIGS_Y_Count        CIGS_All_Count        Drvd_CIGS_Flag/*      DataLineage*/        ;run;sasfile COMMON.SBG_AR_RCMS_G_&MK. close;/*---s060.050: Invoice Discounting - Group-level*/proc sql;   create table COMMON.SBG_AR_INVDISC_&MK. as     (select             Group_ID            ,InvoiceFinance_Flag            ,count(distinct Acct_Key) as Num_InvFin_Acct            ,sum(Exp_Amt)as Sum_InvoiceFinance_TCE      from COMMON.SBG_AR_INVDISC_pre_&MK.      where InvoiceFinance_Flag = "Y"      Group by             Group_ID            ,InvoiceFinance_Flag     );quit;/*---s060.060: Multi-asset finance - Group-level*/proc sql;   create table COMMON.SBG_AR_MAF_&MK. as     (select distinct             Group_ID            ,"Y" as MAF_Flag      from COMMON.SBG_AR_MAF_pre_&MK.      where Exp_Amt > 5000000     );quit;/*---s060.070: Create index for matching on:*/proc datasets lib = COMMON nolist;/*  modify SBG_AR_RCMS_G;*//*  index create Group_ID;*/    modify SBG_AR_CMS_RFL_&MK.;    index create Group_ID;quit;/*---s060.080: De-dupe RCMS Group_IDs:*//* i.e., roll-up to connection-level from customer-level:*//*proc sql;*//*   create table COMMON.SBG_AR_RCMS_G_DD_&MK. as*//*     (select distinct **//*      from COMMON.SBG_AR_RCMS_G_&MK.*//*   );*//*quit;*//*Use:*//*  COMMON.SBG_AR_RCMS_G2_&MK.*//*---s060.090: Join RCMS data to Report filter subpop (currently, the CMS "file"):*//*sasfile COMMON.SBG_AR_RCMS_G_DD_&MK. load;*/sasfile COMMON.SBG_AR_RCMS_G2_&MK. load;sasfile COMMON.SBG_AR_CMS_RFL_&MK. load;data COMMON.SBG_AR_001_&MK.(index=(Group_ID));    Format        CMS_ID 16#        ;    Merge/*      COMMON.SBG_AR_RCMS_G_DD_&MK. (in=inRCMS)*/        COMMON.SBG_AR_RCMS_G2_&MK. (in=inRCMS)        COMMON.SBG_AR_CMS_RFL_&MK. (in=inCMS)        ;    by Group_ID;    if Group_ID ne "";    CMS_ID = substr(Group_ID, 2, 15);    Format        In_CMS_Report_Flag $1.        ;    /* Filter to reportable set of Groups: *//*  if inRCMS;*/    if inCMS;    In_CMS_Report_Flag = "N";    if inCMS then do;        In_CMS_Report_Flag = "Y";    end;    Format        Source $20.        ;    Source = "Z";    if inRCMS and inCMS then do;        Source = "Both";    end;    else do;        if inRCMS and (not inCMS) then do;            Source = "inRCMS only";        end;        else do;            if (not inRCMS) and inCMS then do;                Source = "inCMS only";            end;        end;    end;run;/*sasfile COMMON.SBG_AR_RCMS_G_DD_&MK. close;*/sasfile COMMON.SBG_AR_RCMS_G2_&MK. close;sasfile COMMON.SBG_AR_CMS_RFL_&MK. close;/*proc freq data = COMMON.SBG_AR_001_&MK.;*//*  table Source / nocol norow nopercent;*//*  where substr(Group_ID, 1, 1) = "C";*//*quit;*//*proc freq data = COMMON.SBG_AR_001_&MK.;*//*  table Source / nocol norow nopercent;*//*  where substr(Group_ID, 1, 1) = "G";*//*quit;*//*---s060.100: Create Manually Reviewwable file:*/sasfile COMMON.SBG_AR_GT10M_&MK. load;sasfile COMMON.SBG_AR_INVDISC_&MK. load;sasfile COMMON.SBG_AR_MAF_&MK. load;data COMMON.SBG_AR_ManualReviews_&MK.;    Merge        COMMON.SBG_AR_GT10M_&MK.                  (in=inA)        COMMON.SBG_AR_INVDISC_&MK.                (in=inB)        COMMON.SBG_AR_MAF_&MK.                    (in=inC)        ;    by Group_ID;    Format        ManualReview_Flag $1.        ManRevReason_GT10m $1.        ManRevReason_INVDISC $1.        ManRevReason_MAF $1.        ManRevReason_Combo $200.        ;    ManualReview_Flag = "Y";    ManRevReason_GT10m = "N";    ManRevReason_INVDISC = "N";    ManRevReason_MAF = "N";    ManRevReason_Combo = "";    /* gt10m */    if inA then do;        ManRevReason_GT10m = "Y";        ManRevReason_Combo = catx(                                "/"                                ,ManRevReason_Combo                                ,"GT10m"                                );    end;    /* Inv Disc */    if inB then do;        ManRevReason_INVDISC = "Y";        ManRevReason_Combo = catx(                                "/"                                ,ManRevReason_Combo                                ,"InvDisc"                                );    end;    /* MAF */    if inC then do;        ManRevReason_MAF = "Y";        ManRevReason_Combo = catx(                                "/"                                ,ManRevReason_Combo                                ,"MAF"                                );    end;run;sasfile COMMON.SBG_AR_GT10M_&MK. close;sasfile COMMON.SBG_AR_INVDISC_&MK. close;sasfile COMMON.SBG_AR_MAF_&MK. close;/*Look: Dupes:*//*proc sql;*//*   create table COMMON.zLook_Dupes_ManRev as*//*     (select Group_ID*//*          ,count(*) as Num_Rows*//*      from COMMON.SBG_AR_ManualReviews_&MK.*//*    group by*//*      Group_ID*//*          having Num_Rows > 1 *//*   );*//*quit;*//*---s060.110: Get big BLAST recent increases*/proc sql;   create table COMMON.SBG_ARincr_BLAST_&MK.b as     (select Credit_Appln_ID            ,sum(                Proposed_Limit -Current_Limit                ) as Appl_Comm_Incr      from COMMON.SBG_ARincr_BLAST_&MK.      Group by        Credit_Appln_ID        having            Appl_Comm_Incr > 500     );quit;/*---s060.120: Filter BLAST to recent increases*/proc sql;   create table COMMON.SBG_ARincr_BLAST_&MK.c as     (select distinct             appl.Credit_Appln_ID            ,appl.Appln_type            ,appl.ApplnDate            ,appl.CMS_ID            ,appl.Group_Name            ,appl.Decision            ,appl.DecisionDate            ,appl.SettleDate            ,appl.LastReview            ,appl.ProposedReview_Date            ,appl.CurrentReview_Date            ,b.Appl_Comm_Incr            ,case                when (appl.SettleDate is null) then appl.DecisionDate                when (appl.SettleDate > appl.DecisionDate) then SettleDate                Else: appl.DecisionDate             End              as FilterDate                Length 8                format DATETIME22.3      from COMMON.SBG_ARincr_BLAST_&MK. appl          ,COMMON.SBG_ARincr_BLAST_&MK.b b      where appl.Credit_Appln_ID = b.Credit_Appln_ID     )    Order by         CMS_ID        ,FilterDate    ;quit;/*---s060.130: Get latest BLAST recent increase for the Group*/sasfile COMMON.SBG_ARincr_BLAST_&MK.c load;data COMMON.SBG_ARincr_BLAST_&MK.d(index=(Group_ID));    set COMMON.SBG_ARincr_BLAST_&MK.c;    by CMS_ID;    if last.CMS_ID;    Format        Group_ID $16.        L4_Recent_BLAST_Incr_L6M 11#        ;    Group_ID = cats("G"                    ,put(CMS_ID, z15.)                    );    L4_Recent_BLAST_Incr_L6M = Credit_Appln_ID;run;sasfile COMMON.SBG_ARincr_BLAST_&MK.c close;/*---s060.140: Get latest BLAST L12M review for the Group*/sasfile COMMON.SBG_ARrev_BLAST_&MK. load;data COMMON.SBG_ARrev_BLAST_&MK.b;    set COMMON.SBG_ARrev_BLAST_&MK.;    by CMS_ID;    if last.CMS_ID;    Format        Group_ID $16.        L4_Recent_BLAST_Rev_L12M 11#        ;    Group_ID = cats("G"                    ,put(CMS_ID, z15.)                    );    L4_Recent_BLAST_Rev_L12M = Credit_Appln_ID;run;sasfile COMMON.SBG_ARrev_BLAST_&MK. close;/*---s060.xxx: Add in Manual Reviews and recent BLASTs:*/sasfile COMMON.SBG_AR_001_&MK. load;sasfile COMMON.SBG_AR_ManualReviews_&MK. load;sasfile COMMON.SBG_AR_BusTCE_&MK. load;sasfile COMMON.SBG_ARincr_BLAST_&MK.d load;sasfile COMMON.SBG_ARrev_BLAST_&MK.b load;data COMMON.SBG_AR_003_&MK.;    Merge        COMMON.SBG_AR_001_&MK.           (in=inA)        COMMON.SBG_AR_ManualReviews_&MK. (in=inB)        COMMON.SBG_AR_BusTCE_&MK.        (in=inC)        COMMON.SBG_ARincr_BLAST_&MK.d    (in=inD)        COMMON.SBG_ARrev_BLAST_&MK.b     (in=inE)        ;    by Group_ID;    /* CMS Report subpop OR manual reviewable: */    if inA or inB;    run;sasfile COMMON.SBG_AR_001_&MK. close;sasfile COMMON.SBG_AR_ManualReviews_&MK. close;sasfile COMMON.SBG_AR_BusTCE_&MK. close;sasfile COMMON.SBG_ARincr_BLAST_&MK.d close;sasfile COMMON.SBG_ARrev_BLAST_&MK.b close;/*proc print *//*    data = COMMON.SBG_AR_003_&MK. (obs=5)*//*        ;*//*run;*//*Look: Dupes:*//*proc sql;*//*   create table COMMON.zLook_Dupes_2 as*//*     (select Group_ID*//*          ,count(*) as Num_Rows*//*      from COMMON.SBG_AR_003_&MK.*//*    group by*//*      Group_ID*//*          having Num_Rows > 1 *//*   );*//*quit;*//*Adhoc adjustments:*/sasfile COMMON.SBG_AR_003_&MK. load;data COMMON.SBG_AR_003adj_&MK.;    set COMMON.SBG_AR_003_&MK.;    /* Clean-up Segmentation: */    if BCH_NAME = "Newcastle and Central Coast" then do;        SEGMENT = "Commercial";    end;    if REGION = "BSA Regional" then do;        SEGMENT = "Commercial";    end;    /* Reset BSA Regional to commercial */    /* GB branches */    if Ro_Mgmt_Bch_Cde in (857            ,863            ,866                ) then do;            REGION = "Commercial Regional BSA";            SEGMENT = "Commercial";    end;/*  CIGS:*/    if CIGS_Flag eq "" then do;        CIGS_Flag = "Z";    end;    rename        CIGS_Flag = CIGS        ;run;sasfile COMMON.SBG_AR_003_&MK. close;proc freq data = COMMON.SBG_AR_003adj_&MK.;    table CIGS / nocol norow nopercent;quit;/*proc freq data = COMMON.SBG_AR_003adj_&MK.;*//*  table CIGS / nocol norow nopercent;*//*quit;*//*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*    x x  x x  x x  x x  x x  x x  x x  x x  x x  x x    *//*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*   ~                                                ~   *//*              {   End of code block   }                 *//*  M=<================= oooOooo ====================>=M  *//*                                                        *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*History of adds: L12M:*//*%macro DummyHistory;*//*  %do k = 2 %to 13;*//*      %let TheMK = &&m&k..;*//*      proc sql;*//*         create table COMMON.SBG_AR_HistAdd_&TheMK. like COMMON.SBG_AR_HistAdd_&MK.;*//*      quit;*//*  %end;*//*%mend;*//*%DummyHistory*//*data COMMON.SBG_AR_HistAdd_201511;*//*  set COMMON.SBG_AR_HistAdd_&MK. (obs=200);*//*run;*/%put M1 = &M1. M12 = &M12.;%macro CreateL12MHistory;    data COMMON.SBG_AR_HistAdd_All(index=(Group_ID));        set            %do k = 2 %to 13;                %let TheMK = &&m&k..;                COMMON.SBG_AR_HistAdd_&TheMK. (in = in&k.)            %end;            ;        Format            Month_Key $6.            ;            %do k = 2 %to 13;                %let TheMK = &&m&k..;                if in&k. then do;                    Month_Key = "&TheMK.";                end;            %end;    run;%mend;%CreateL12MHistory/*proc freq data = COMMON.SBG_AR_HISTADD_201605_v1;*//*  table L4a_Node_ID / nocol norow nopercent;*//*quit;*//*data COMMON.SBG_AR_HISTADD_201605;*//*  set COMMON.SBG_AR_HISTADD_201605_v1;*//*  if L4a_Node_ID not in (*//*           "17"*//*          ,"18"*//*          ,"19"*//*      );*//*run;*//*proc freq data = COMMON.SBG_AR_HISTADD_201605;*//*  table L4a_Node_ID / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.SBG_AR_HISTADD_201606;*//*  table L4a_Node_ID / nocol norow nopercent;*//*quit;*/sasfile COMMON.SBG_AR_HistAdd_All load;data COMMON.SBG_AR_Hist_Tags;    set COMMON.SBG_AR_HistAdd_All (keep =                    Group_ID                    Month_Key                    calcNext_Review_Date                    L4a_Node_ID                    NewAdds_Flag                        );    by Group_ID;    if first.Group_ID;    Format        Hist_Added_L12M_Flag $1.        ;    Hist_Added_L12M_Flag = "Y";run;sasfile COMMON.SBG_AR_HistAdd_All close;sasfile COMMON.SBG_AR_Hist_Tags load;data COMMON.SBG_AR_Hist_TagsAdds;    set COMMON.SBG_AR_Hist_Tags;    if NewAdds_Flag = "Y";run;sasfile COMMON.SBG_AR_Hist_Tags close;proc sql;   create table COMMON.SBG_AR_Hist_TagsAdds_n1 as     (select count(distinct Group_ID) as Num_Groups            ,count(*) as Num_Rows      from COMMON.SBG_AR_Hist_TagsAdds     );quit;proc freq data = COMMON.SBG_AR_Hist_Tags;    table Month_Key * Hist_Added_L12M_Flag / nocol norow nopercent;quit;/*proc freq data = COMMON.SBG_AR_Hist_Tags;*//*  table calcNext_Review_Date * L4a_Node_ID / nocol norow nopercent;*//*  where NewAdds_Flag = "Y"*//*    and Month_Key = "201605"*//*    ;*//*quit;*//*proc freq data = COMMON.SBG_AR_HistAdd_201606;*//*  table calcNext_Review_Date * L4a_Node_ID / nocol norow nopercent;*//*  where NewAdds_Flag = "Y"*//*    ;*//*quit;*//*%Format_Subpop(*//*    INLIB=COMMON,*//*    INDSN=SBG_AR_Hist_Tags,*//*    FMTLIB=COMMON,*//*    FMTDSN=FMT_SBG_HistAdds,*//*    FMTNAME=FHISTA,*//*    FMTTYPE=C,*//*    KEYCOL=Group_ID,*//*    OTHER=*//*    )*//**//*%Format_Classing(*//*    INLIB=COMMON,*//*    INDSN=SBG_AR_Hist_Tags,*//*    FMTLIB=COMMON,*//*    FMTDSN=FMT_SBG_HistAddsB,*//*    FMTNAME=FHISTB,*//*    FMTTYPE=C,*//*    KEYCOL=Group_ID,*//*    TAGCOL=calcNext_Review_Date,*//*    OTHER=*//*    )*//*Fold in the history L12M:*/proc sql;   create table COMMON.SBG_AR_004_&MK. as     (select a.*            ,b.calcNext_Review_Date as histNext_Review_Date            ,b.Hist_Added_L12M_Flag            ,case                when (                           /* GB: SME definition (26-Feb-2016: */                                                       (                                    /* MANUAL REVIEW METRO */                                    /* 1.1 */                                    (                                    Segment in ("SME Metro")                                    AND                                    GRP_RVW_FLG not in ("A","?", " ", "")                                    and                                    Commercial_Exposure >= 250000                                    )                                OR                                    /* REGIONAL AUTO REVIEW */                                    /* 1.2 */                                    (                                    Region in ("NSW Regional")                                    AND                                    Commercial_Exposure >= 1000000                                    AND                                    CIGS in ("N","Z")                                    )                                OR                                    /* REGIONAL MANUAL REVIEW */                                    /* 1.3 */                                    (                                    Region in ("NSW Regional")                                    AND                                    Commercial_Exposure >= 1000000                                    AND                                    ManRevReason_Combo ^= (" ")                                    )                                OR                                    /* BSA SME */                                    /* 1.4 */                                    (                                    Ro_Mgmt_Bch_Cde in (460                                            ,852                                            ,875                                            ,877                                            )                                    AND                                    Commercial_Exposure >= 250000                                    AND                                    CIGS in ("N","Z")                                    )                            )                    ) then "Y"                else "N"            end As GBC_Flag      from COMMON.SBG_AR_003adj_&MK. a      left outer join COMMON.SBG_AR_Hist_Tags b      on a.Group_ID = b.Group_ID     );quit;/*proc freq data = COMMON.SBG_AR_004_&MK.;*//*  table Hist_Added_L12M_Flag / nocol norow nopercent missing;*//*quit;*//*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*    x x  x x  x x  x x  x x  x x  x x  x x  x x  x x    *//*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*   ~                                                ~   *//*              {   End of code block   }                 *//*  M=<================= oooOooo ====================>=M  *//*                                                        *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*Treatment:*//*----------------------------------------------------*//*Variable domain values are in:                      *//*  WB = C:\ar\output\SBG_L4a_FreqMap.xlsb            *//*      created by:                                   *//*              COMMON_002_proc_Freq_L4a_vars.sas     *//*----------------------------------------------------*//*options mprint mlogic symbolgen;*//*options nomprint nomlogic nosymbolgen;*//*------------------------------------------------------------*//*Values from:                                                *//*  wb = C:\ar\output\Logic 4a for SGB PRR Reporting.xlsx     *//*  ws = Subpops                                              *//*  col = C                                                   *//*------------------------------------------------------------*/%LET  Cond1  =  %QUOTE(  UpCase(SEGMENT)  =  "ASSET FINANCE"  AND  GRP_RVW_FLG ne "A"              );%LET  Cond2  =  %QUOTE(  CR_Manager ^= ""                    );%LET  Cond3  =  %QUOTE(  UpCase(SEGMENT)  =  "RETAIL"                    );%LET  Cond4  =  %QUOTE(  UpCase(SEGMENT)  =  "SME METRO"  AND  GRP_RVW_FLG  =  "A"              );%LET  Cond5  =  %QUOTE(  Bus_TCE < 250000                    );%LET  Cond6  =  %QUOTE(  GRP_RVW_FLG in  ("?", " ", "")  OR  WBC_PD  =  "?"              );%LET  Cond7  =  %QUOTE(  UpCase(SEGMENT)  =  "PROPERTY"  AND  GRP_RVW_FLG ne "A"              );%LET  Cond8  =  %QUOTE(  UpCase(SEGMENT)  =  "CORPORATE"  AND  GRP_RVW_FLG ne "A"              );%LET  Cond9  =  %QUOTE(  UpCase(SEGMENT)  =  "COMMERCIAL"  AND  GRP_RVW_FLG ne "A"              );%LET  Cond10  =  %QUOTE(  UpCase(SEGMENT)  =  "SME METRO"  AND  GRP_RVW_FLG ne "A"              );%LET  Cond11  =  %QUOTE(  UpCase(REGION)  =  "NSW REGIONAL"  AND  GRP_RVW_FLG ne "A"              );%LET  Cond12  =  %QUOTE(  ManRevReason_GT10m  =  "Y"  OR  ManRevReason_INVDISC  =  "Y"  OR  ManRevReason_MAF  =  "Y"        );%LET  Cond13  =  %QUOTE(  substr(WBC_PD, 1, 1) in  ("E","F","G","H")  AND  CR_Manager = ""  AND  GRP_RVW_FLG ne "A"        );%LET  Cond14  =  %QUOTE(( UpCase(cats(Watchlist))  =  "YES"  OR  UpCase(cats(Secondary_Watchlist))  =  "YES" ) AND  CR_Manager = ""  AND  GRP_RVW_FLG ne "A"  );%LET  Cond15  =  %QUOTE(  GRP_RVW_FLG  =  "A"  AND  CIGS ne "Y"  AND  L4_Recent_BLAST_Incr_L6M eq .  AND  L4_Recent_BLAST_Rev_L12M eq .  );%LET  Cond16  =  %QUOTE(  substr(WBC_PD, 1, 1) in  ("E","F","G","H")  AND  CR_Manager = ""  AND  GRP_RVW_FLG  =  "A"        );%LET  Cond17  =  %QUOTE(( UpCase(cats(Watchlist))  =  "YES"  OR  UpCase(cats(Secondary_Watchlist))  =  "YES" ) AND  CR_Manager = ""  AND  GRP_RVW_FLG  =  "A"  );%LET  Cond18  =  %QUOTE(  GRP_RVW_FLG  =  "A"  AND  CIGS ne "Y"  AND  L4_Recent_BLAST_Incr_L6M > 0  AND  L4_Recent_BLAST_Rev_L12M eq .  );%LET  Cond19  =  %QUOTE(  GRP_RVW_FLG  =  "A"  AND  CIGS ne "Y"  AND  L4_Recent_BLAST_Incr_L6M eq .  AND  L4_Recent_BLAST_Rev_L12M > 0  );%LET  Cond20  =  %QUOTE(  GRP_RVW_FLG  =  "A"  AND  CIGS ne "Y"  AND  L4_Recent_BLAST_Incr_L6M > 0  AND  L4_Recent_BLAST_Rev_L12M > 0  );%LET  Cond21  =  %QUOTE(  GRP_RVW_FLG  =  "A"  AND  CIGS = "Y"              );%LET  Cond22  =  %QUOTE(  UpCase(SEGMENT)  =  "ASSET FINANCE"  AND  GRP_RVW_FLG ne "A"              );%let CondTot = 22;/*------------------------------------------------------------*//*Values from:                                                *//*  wb = C:\ar\output\Logic 4a for SGB PRR Reporting.xlsx     *//*  ws = Subpops                                              *//*  col = A                                                   *//*------------------------------------------------------------*//*PROC FORMAT Note:                     *//*  3  =  " GRF="A", SME Metro"         *//*comes out as                          *//*  GRF=A, SME Metro                    *//*--------------------------------------*/proc format;    Value FRule1  =  " Asset Finance segment, manual review"2  =  " LMU"3  =  " Retail Segment"4  =  " GRF=A, SME Metro"5  =  " BusTCE <$250k"6  =  " GRF undefined"7  =  " Property segment, manual review"8  =  " Corporate segment, manual review"9  =  " Commercial  segment, manual review"10  =  " SME Metro segment, manual review"11  =  " NSW Regional, manual review"12  =  " Exposure: >10m bus TCE or ID or MAF"13  =  " E-H, manual review"14  =  " Watchlist, manual review"15  =  " Failed CIGS, no recent BLASTs"16  =  " E-H, auto review"17  =  " Watchlist, auto review"18  =  " GRF=A, CIGS=N, Yes BLAST incr, No BLAST rev"19  =  " GRF=A, CIGS=N, No BLAST incr, Yes BLAST rev"20  =  " GRF=A, CIGS=N, Yes BLAST incr, Yes BLAST rev"21  =  " GRF=A, CIGS=Y"22  =  " Asset Finance, unassigned node"99  =  " Unassigned node";quit;/*------------------------------------------------------------*//*Values from:                                                *//*  wb = C:\ar\output\Logic 4a for SGB PRR Reporting.xlsx     *//*  ws = Subpops                                              *//*  col = E                                                   *//*------------------------------------------------------------*/proc format;    value $FRGRPY "01","07","08","09","10","11","12","13","14","15","16","17","22" ="Y" other = "N" ;quit;/*------------------------------------------------------------*//*Values from:                                                *//*  wb = C:\ar\output\Logic 4a for SGB PRR Reporting.xlsx     *//*  ws = Subpops                                              *//*  col = F                                                   *//*------------------------------------------------------------*/proc format;    value $FUManD "01","07","08","09","10","11","13","14","22" = "Y" other = "N" ;quit;/*------------------------------------------------------------*//*Values from:                                                *//*  wb = C:\ar\output\Logic 4a for SGB PRR Reporting.xlsx     *//*  ws = Subpops                                              *//*  col = G                                                   *//*------------------------------------------------------------*/proc format;    value $FManDte "12"= "Y"other = "N" ;quit;/*------------------------------------------------------------*//*Values from:                                                *//*  wb = C:\ar\output\Logic 4a for SGB PRR Reporting.xlsx     *//*  ws = Subpops                                              *//*  col = I                                                   *//*------------------------------------------------------------*/proc format;    value $FAutDte "15","16","17" = "Y" other = "N" ;quit;%put  dmARD = &dmARD. dmARDGAR = &dmARDGAR. ;/*sasfile &ARFinNameFB.L4b load;*/sasfile COMMON.SBG_AR_004_&MK. load;data COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;/*  set &ARFinNameFB.L4b;*/    set COMMON.SBG_AR_004_&MK.;    Format        L4a_Node_ID $8.        L4a_Reportable_Flag $1.        ;    select;        when (&Cond1.)  do; L4a_Node_ID = "01"; end;        when (&Cond2.)  do; L4a_Node_ID = "02"; end;        when (&Cond3.)  do; L4a_Node_ID = "03"; end;        when (&Cond4.)  do; L4a_Node_ID = "04"; end;        when (&Cond5.)  do; L4a_Node_ID = "05"; end;        when (&Cond6.)  do; L4a_Node_ID = "06"; end;        when (&Cond7.)  do; L4a_Node_ID = "07"; end;        when (&Cond8.)  do; L4a_Node_ID = "08"; end;        when (&Cond9.)  do; L4a_Node_ID = "09"; end;        when (&Cond10.) do; L4a_Node_ID = "10"; end;        when (&Cond11.) do; L4a_Node_ID = "11"; end;        when (&Cond12.) do; L4a_Node_ID = "12"; end;        when (&Cond13.) do; L4a_Node_ID = "13"; end;        when (&Cond14.) do; L4a_Node_ID = "14"; end;        when (&Cond15.) do; L4a_Node_ID = "15"; end;        when (&Cond16.) do; L4a_Node_ID = "16"; end;        when (&Cond17.) do; L4a_Node_ID = "17"; end;        when (&Cond18.) do; L4a_Node_ID = "18"; end;        when (&Cond19.) do; L4a_Node_ID = "19"; end;        when (&Cond20.) do; L4a_Node_ID = "20"; end;        when (&Cond21.) do; L4a_Node_ID = "21"; end;        when (&Cond22.) do; L4a_Node_ID = "22"; end;        otherwise do;                L4a_Node_ID = "99";            end;    end;    select;        when (                put(L4a_Node_ID, ? $FRGRPY.) = "Y"                )            do;                L4a_Reportable_Flag = "Y";            end;        otherwise do;                L4a_Reportable_Flag = "N";            end;    end;    L4a_Node_Description = put(input(L4a_Node_ID, ? 4.), ? FRule.);    /* Next Review Date calc: ------------------ */    Format        calcNext_Review_Date date9.        NewAdds_Flag $1.        HistCarryOver_Flag $1.        ;    NewAdds_Flag = "N";    HistCarryOver_Flag = "N";    select;        /* manually-set date: */        /* Use CMS Date: */        when (                put(L4a_Node_ID, ? $FUManD.) = "Y"/*              L4a_Node_ID in (*//*                   "06"*//*                  ,"07"*//*                  ,"08"*//*                  ,"09"*//*                  ,"10"*//*                  ,"12"*//*                  ,"13"*//*                  ,"21"*//*              )*/            )            do;                calcNext_Review_Date = Next_Rvw_Dte;            end;        /* manual reviews: auto-set date */        when (                put(L4a_Node_ID, ? $FManDte.) = "Y"/*              L4a_Node_ID in (*//*                   "11"*//*              )*/            )            do;                select;                    /* keep historically-assigned date*/                    when (Hist_Added_L12M_Flag = "Y")                        do;                            calcNext_Review_Date = histNext_Review_Date;                            HistCarryOver_Flag = "Y";                        end;                    otherwise do;                            /* new add: */                            calcNext_Review_Date = "&dmARDGAR."d;                            NewAdds_Flag = "Y";                        end;                end;            end;        /* auto reviews: auto-set date */        when (                put(L4a_Node_ID, ? $FAutDte.) = "Y"/*              L4a_Node_ID in (*//*                   "14"*//*                  ,"15"*//*                  ,"16"*//*              )*/            )            do;                select;                    /* keep historically-assigned date*/                    when (Hist_Added_L12M_Flag = "Y")                        do;                            calcNext_Review_Date = histNext_Review_Date;                            HistCarryOver_Flag = "Y";                        end;                    otherwise do;                            /* new add: */                            calcNext_Review_Date = "&dmARD."d;                            NewAdds_Flag = "Y";                        end;                end;            end;        otherwise do;                calcNext_Review_Date = -1;            end;    end;    /* Overdue calc: --------------------------- */    /* Days' grace for overdue calculation: */    /*Overdue calc:*/    /*if */    /*  Auto review flag*/    /*,Watchlist,*/    /*,<=E35*/    /*          = 1 day*/    /*Manual review flag */    /*          = 45 days' grace*/    Format        Num_DaysGrace 4#        calcOverDue_Flag $3.        ;        select;        when (                (                    GRP_RVW_FLG = "A"                )                or                (                    substr(WBC_PD, 1, 1) in  ("E","F","G","H")                )                or                (                    UpCase(cats(Watchlist)) = "YES"                    OR                    UpCase(cats(Secondary_Watchlist)) = "YES"                )            )            do;                Num_DaysGrace = 1;            end;        when (                    GRP_RVW_FLG ^= "A"                )            do;                Num_DaysGrace = 45;            end;        otherwise do;                Num_DaysGrace = -99;            end;    end;    calcOverDue_Flag= "";    if        calcNext_Review_Date + Num_DaysGrace < "&qDayEOM."d            then do;                calcOverDue_Flag = "YES";    end;run;/*sasfile &ARFinNameFB.L4b close;*/sasfile COMMON.SBG_AR_004_&MK. close;/*ods pdf file="c:\ar\output\SBG_AR_Nodes_before.pdf" notoc style=sasweb;*//*TItle "SBG_AR_Nodes_before";*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table L4a_Node_ID / nocol norow nopercent;*//*quit;*//*ods pdf close;*//*ods pdf file="c:\ar\output\SBG_AR_Nodes_after.pdf" notoc style=sasweb;*//*TItle "SBG_AR_Nodes_after (AF)";*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table L4a_Node_ID / nocol norow nopercent;*//*quit;*//*ods pdf close;*/sasfile COMMON.SBG_AR_FinOutREVIEW_&MK.L4a load;data COMMON.SBG_AR_UnassDates_&MK.;    set COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;    if L4a_Reportable_Flag = "Y"    and calcNext_Review_Date = -1    ;run;sasfile COMMON.SBG_AR_FinOutREVIEW_&MK.L4a close;/*Populate a new Excel worksheet from SAS.*/libname XL EXCEL "c:\ar\output\SBG_AR_UnassignedDates_&MK..xlsb";proc datasets lib = XL nolist;    Delete Data;quit;data XL.Data;    set COMMON.SBG_AR_UnassDates_&MK.;run;libname XL clear;proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;    table L4a_Node_Description  / nocol norow nopercent missing;    table L4a_Node_ID  / nocol norow nopercent missing;    where L4a_Reportable_Flag = "Y";quit;proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;    table HistCarryOver_Flag * NewAdds_Flag  / nocol norow nopercent missing;    where L4a_Reportable_Flag = "Y"      and put(L4a_Node_ID, ? $FManDte.) = "Y"/*    and L4a_Node_ID in (*//*                   "11"*//*              )*/    ;quit;proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;    table calcNext_Review_Date  / nocol norow nopercent missing;    where L4a_Reportable_Flag = "Y"      and put(L4a_Node_ID, ? $FManDte.) = "Y"/*    and L4a_Node_ID in (*//*                   "11"*//*              )*/      and HistCarryOver_Flag = "Y"        ;quit;/*calcNext_Review_Date  Frequency   Cumulative Frequency *//*04JUL2016             1           1                    *//*31MAR2017             89          90                   */proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;    table calcNext_Review_Date  / nocol norow nopercent missing;    where L4a_Reportable_Flag = "Y"      and put(L4a_Node_ID, ? $FAutDte.) = "Y"/*              L4a_Node_ID in (*//*                   "14"*//*                  ,"15"*//*                  ,"16"*//*              )*/      and HistCarryOver_Flag = "Y"        ;quit;/*NOTE: There were 0 observations*//*NOTE: There were 204 observations *//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table L4a_Node_ID * L4a_Reportable_Flag / nocol norow nopercent missing;*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table HistCarryOver_Flag * NewAdds_Flag / nocol norow nopercent missing;*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table GBC_Flag * L4a_Reportable_Flag / nocol norow nopercent missing;*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table calcNext_Review_Date / nocol norow nopercent missing;*//*  where L4a_Node_ID = "99";*//*quit;*//*---*//*Make history file:*/proc sql;   create table COMMON.SBG_AR_HistAdd_&MK. as     (select *      from COMMON.SBG_AR_FinOutREVIEW_&MK.L4a    where        /* new *//*      (*/            L4a_Reportable_Flag = "Y"/*          and*//*        NewAdds_Flag = "Y"*//*      )*//*      or*/        /*Historicaly added *//*      (*//*      xxx = "Y";*//*      )*/     );quit;proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;    table L4a_Reportable_Flag * NewAdds_Flag / nocol norow nopercent;quit;proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;    table HistCarryOver_Flag * NewAdds_Flag / nocol norow nopercent;quit;/*proc contents *//*    data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a; *//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table calcNext_Review_Date * calcOverDue_Flag / nocol norow nopercent missing;*//*  where L4a_Reportable_Flag = "Y";*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table NewAdds_Flag * calcOverDue_Flag / nocol norow nopercent missing;*//*  where L4a_Reportable_Flag = "Y";*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table calcNext_Review_Date * calcOverDue_Flag / nocol norow nopercent missing;*//*  where L4a_Reportable_Flag = "Y"*//*          and*//*        NewAdds_Flag = "Y"*//*          ;*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table Watchlist / nocol norow nopercent missing;*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table L4a_Node_ID * Num_DaysGrace / nocol norow nopercent missing;*//*  where L4a_Reportable_Flag = "Y";*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table calcOverDue_Flag * Num_DaysGrace / nocol norow nopercent missing;*//*  where L4a_Reportable_Flag = "Y";*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table L4a_Node_ID * L4a_Reportable_Flag / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table WBC_PD / nocol norow nopercent missing;*//*  where L4a_Reportable_Flag = "Y";*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table L4a_Node_ID / nocol norow nopercent missing;*//*  where L4a_Reportable_Flag = "Y"*//*          and*//*          WBC_PD = "?"*//*          ;*//*quit;*//*  if WBC_PD ne "?";*/%macro Scan_Subpops;    %do i = 1 %to &CondTot.;        %let TheCOND = &&Cond&i..;        proc sql;           create table COMMON.SBG_AR_L_&i. as             (select "Cond&i." as Subpop                            Length 10                            format $10.                    ,count(distinct Group_ID) as Num_Groups              from COMMON.SBG_AR_FinOutREVIEW_&MK.L4a              where &TheCOND.              Group by                    Subpop             );        quit;    %end;    data COMMON.SBG_AR_L_All;        set            %do i = 1 %to &CondTot.;                COMMON.SBG_AR_L_&i.            %end;        ;    run;%mend;%Scan_Subpopsproc sql;   create table COMMON.SBG_AR_L_All_Nodes as     (select L4a_Node_ID            ,count(distinct Group_ID) as Node_Total      from COMMON.SBG_AR_FinOutREVIEW_&MK.L4a      Group by        L4a_Node_ID     );quit;/*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table L4a_Node_ID / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.SBG_AR_L_All_Nodes;*//*  table L4a_Node_ID / nocol norow nopercent;*//*quit;*//*All in A table:*/proc sql;   create table COMMON.SBG_AR_L_All2 as     (select a.*            ,b.Node_Total      from COMMON.SBG_AR_L_All a      left outer join COMMON.SBG_AR_L_All_Nodes b      on input(substr(Subpop, 5, 2), ? 4.) = input(b.L4a_Node_ID, ? 4.)     );quit;proc print    Data = COMMON.SBG_AR_L_All2        ;run;/*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table L4a_Node_ID / nocol norow nopercent;*//*  where &Cond11.;*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table L4a_Node_ID / nocol norow nopercent;*//*  where &Cond13.;*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table SEGMENT / nocol norow nopercent;*//*  where *//*          L4a_Node_ID = "11"*//*          ;*//*quit;*//*proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;*//*  table SEGMENT / nocol norow nopercent missing;*//*  where &Cond11.;*//*quit;*//*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*    x x  x x  x x  x x  x x  x x  x x  x x  x x  x x    *//*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*   ~                                                ~   *//*              {   End of code block   }                 *//*  M=<================= oooOooo ====================>=M  *//*                                                        */;/**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*Monitoring Reports:*//*Monitoring Report 1:*//*Subpops by Node_ID:*/%macro MR_001;    proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;        table L4a_Node_ID /                        norow                        nopercent                        missing                        noprint                        outcum                out = COMMON_SBG_AR_MR001_0                ;    quit;    %do i = 1 %to &CondTot.;        %let TheCond = &&Cond&i..;        proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;            table L4a_Node_ID /                        norow                        nopercent                        missing                        noprint                        outcum                    out = COMMON_SBG_AR_MR001_&i.                    ;            where &TheCond.;        quit;    %end;    /* The Subpops: */    data COMMON.SBG_AR_MR_Subpops;        Format            Condition $5.            Definition $200.            ;        %do i = 1 %to &CondTot.;            %let TheCond = %BQUOTE( &&Cond&i..);            Condition = "&i.";            Definition = "&TheCond.";            output;        %end;    run;    /*Populate a new Excel worksheet from SAS.*/    libname XL EXCEL "c:\ar\output\SBG_AR_MR001_&MK..xlsb";        proc datasets lib = XL nolist;            Delete Subpop_List;        quit;        data XL.Subpop_List;            set COMMON.SBG_AR_MR_Subpops;        run;    %do i = 0 %to &CondTot.;        proc datasets lib = XL nolist;            Delete Data_&i.;        quit;        data XL.Data_&i.;            set COMMON_SBG_AR_MR001_&i.;        run;    %end;    libname XL clear;%mend;%MR_001/*Monitoring Report 2:*//*Unassigned Node IDs:*/libname XL EXCEL "c:\ar\output\SBG_AR_MR002_&MK..xlsb";    proc datasets lib = XL nolist;        Delete Data;    quit;    data XL.Data;        set COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;        if L4a_Node_ID = "99";    run;libname XL clear;/*Monitoring Report 3:*//*Subpop tagging for each Customer Group:*/%macro MR_003;    %do i = 1 %to &CondTot.;        %let TheCond = &&Cond&i..;        proc sql;           create table work.c&i. as             (select distinct                        Group_ID                    ,"Y" as Cond&i._Met              from COMMON.SBG_AR_FinOutREVIEW_&MK.L4a              where &TheCond.             );        quit;    %end;    /* The Subpops: */    data work.c_All;        Format        %do i = 1 %to &CondTot.;            Cond&i._Met $1.        %end;            ;        Merge            %do i = 1 %to &CondTot.;                work.c&i.            %end;            ;        by Group_ID;    run;    /*  Add the Cond_ flags to the main data table:*/    proc sql;       create table COMMON.SBG_AR_FinOut_&MK.L4a2 as         (select a.*                %do i = 1 %to &CondTot.;                    ,b&i..Cond&i._Met                %end;          from COMMON.SBG_AR_FinOutREVIEW_&MK.L4a a            %do i = 1 %to &CondTot.;          left outer join work.c&i. b&i.          on a.Group_ID = b&i..Group_ID            %end;         );    quit;    /*Populate a new Excel worksheet from SAS.*/    libname XL EXCEL "c:\ar\output\SBG_AR_MR003_&MK..xlsb";        proc datasets lib = XL nolist;            Delete Data;        quit;        data XL.data;            set COMMON.SBG_AR_FinOut_&MK.L4a2;            Format                Cond99_Flag $1.                ;            Cond99_Flag = "Y";            %do i = 1 %to &CondTot.;                if Cond&i._Met = "Y" then do;                    Cond99_Flag = "N";                end;            %end;            Format                Count 8#                ;            Count = 1;        run;    libname XL clear;%mend;%MR_003proc freq data = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;    table L4a_Node_ID / nocol norow nopercent;    where SEGMENT = "Asset Finance"      and CIGS = "Z"      and GRP_RVW_FLG ^= "A"      ;quit;/*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*    x x  x x  x x  x x  x x  x x  x x  x x  x x  x x    *//*    xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx  xxx    *//*   ~                                                ~   *//*              {   End of code block   }                 *//*  M=<================= oooOooo ====================>=M  *//*                                                        *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*Output:*//*Hive off CIGS=Z:*/sasfile COMMON.SBG_AR_FinOutREVIEW_&MK.L4a load;Data    COMMON.SBG_AR_FinOutREVIEW_& MK.L4az    COMMON.SBG_AR_FinOutREVIEW_& MK.L4an    ;    set COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;    /* no review dates: */    if calcNext_Review_Date ne -1;    if (        UpCase(SEGMENT) = "ASSET FINANCE"        and        GRP_RVW_FLG ^= "A"        )            then do;            output COMMON.SBG_AR_FinOutREVIEW_&MK.L4an;    end;    else do;        if CIGS = "Z"            then do;            output COMMON.SBG_AR_FinOutREVIEW_&MK.L4az;        end;        else do;            output COMMON.SBG_AR_FinOutREVIEW_&MK.L4an;        end;    end;run;sasfile COMMON.SBG_AR_FinOutREVIEW_&MK.L4a close;/*Staging tables:*//*---s060.070fb: Total Group Managed:*/data COMMON.STGTotal_Group_Managed_&MK.;    set COMMON.SBG_INFILE_TotalGM_&MK.;run;/*---s060.080fb: Full list:*/data COMMON.STG_ORFull_ListRptFB_&MK.;    Format        F1 8#        ;    set COMMON.SBG_AR_FinOutREVIEW_&MK.L4an(drop=F1);    if _N_ = 1 then do;        F1 = 0;    end;    if L4a_Reportable_Flag = "Y" then do;        F1 = F1 + 1;        output;    end;    retain F1;run;/*---s060.090fb: Overdue list:*/data COMMON.STG_Overdue_Review_RptFB_&MK.;    Format        F1 8#        ;    set COMMON.SBG_AR_FinOutREVIEW_&MK.L4an (drop = F1);    if _N_ = 1 then do;        F1 = 0;    end;    if calcOverDue_Flag = "YES"        and        L4a_Reportable_Flag = "Y"        then do;        F1 = F1 + 1;        output;    end;    retain F1;run;/*proc freq data = COMMON.STG_Overdue_Review_RptFB_&MK.;*//*  table GB_Reviews_Flag * L4_Overdue_Flag / nocol norow nopercent missing;*//*  table GB_Reviews_Flag * L4_MeetsManRev_Flag / nocol norow nopercent;*//*  table L4_Next_Review_Date * GB_Reviews_Flag  / nocol norow nopercent;*//*quit;*//*---s060.100fb: Upcoming:*/data COMMON.STG_Upcoming_ReviewRptFB_&MK.;    Format        F1 8#        ;    set COMMON.SBG_AR_FinOutREVIEW_&MK.L4an (drop = F1);    if _N_ = 1 then do;        F1 = 0;    end;    if calcOverDue_Flag ne "YES"        and        L4a_Reportable_Flag = "Y"        then do;        F1 = F1 + 1;        output;    end;    retain F1;run;/*EXCEL:*//*Full file:*/libname XL EXCEL "c:\ar\output\SBG_Fullfile_L4a_&MK..xlsb";proc datasets lib = XL nolist;    Delete Data;quit;data XL.Data;    set COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;run;libname XL clear;libname XL EXCEL "c:\ar\output\SCODR001 - CMS Overdue Reviews_&MK._CIGSFBL4.xls";/*SELECT statement from:*//*  wb = C:\ar\output\SBG_AR_Report_Metadata.xlsx*//*  ws = Columns*//*Overdue list:*//*Overdue Review Report:*/proc datasets lib = XL nolist;    Delete ORR;quit;proc sql;   create table XL.ORR as     (select             F1            ,Ro_Mgmt_Bch_Cde            ,BCH_NAME            ,SEGMENT            ,REGION            ,GEOGRAPHY            ,GLOBL_CNTL_PT            ,Staff_Nme            ,GRP_NME            ,Group_ID as CUST_GRP_ID/*          ,Next_Rvw_Dte*/            ,calcNext_Review_Date as Next_Rvw_Dte                Length 8                format date9./*          ,L4_Next_Review_Date as Next_Rvw_Dte*/            ,Extract_Date/*              length 8*//*              format date9.*/            ,Extract_Date - calcNext_Review_Date as Days_Diff            ,GRP_LMT            ,GRP_USG            ,GRP_EXP            ,WBC_PD            ,GRP_RVW_FLG/*          ,LMU_Manager*/            ,CR_Manager            ,Watchlist        ,CIGS        ,CIGS_Outcome_Combo      from COMMON.STG_Overdue_Review_RptFB_&MK.     );quit;/*TotalGM: keep unchanged:*//*Total Group Managed:*/proc datasets lib = XL nolist;    Delete Total_Group_Managed;quit;data XL.Total_Group_Managed;    set COMMON.STGTotal_Group_Managed_&MK.;run;/*Upcoming:*//*Upcoming Review:*/proc datasets lib = XL nolist;    Delete UR;quit;proc sql;   create table XL.UR as     (select             F1            ,Ro_Mgmt_Bch_Cde            ,BCH_NAME            ,SEGMENT            ,REGION            ,GEOGRAPHY            ,GLOBL_CNTL_PT            ,Staff_Nme            ,GRP_NME            ,Group_ID as CUST_GRP_ID/*          ,Next_Rvw_Dte*/            ,calcNext_Review_Date as Next_Rvw_Dte                Length 8                format date9./*          ,L4_Next_Review_Date as Next_Rvw_Dte*/            ,Extract_Date/*              length 8*//*              format date9.*/            ,GRP_LMT            ,GRP_USG            ,GRP_EXP            ,WBC_PD            ,GRP_RVW_FLG/*          ,LMU_Manager*/            ,CR_Manager            ,Watchlist            ,Commercial_Exposure            ,Retail_Exposure            ,Secondary_Watchlist            ,SRC_APPL        ,CIGS        ,CIGS_Outcome_Combo      from COMMON.STG_Upcoming_ReviewRptFB_&MK.     );quit;/*Overdue_Review_Full_Listing:*/proc datasets lib = XL nolist;    Delete ORFL;quit;proc sql;   create table XL.ORFL as     (select             F1            ,Ro_Mgmt_Bch_Cde            ,BCH_NAME            ,SEGMENT            ,REGION            ,GEOGRAPHY            ,GLOBL_CNTL_PT            ,Staff_Nme            ,GRP_NME            ,Group_ID as CUST_GRP_ID/*          ,Next_Rvw_Dte*/            ,calcNext_Review_Date as Next_Rvw_Dte                Length 8                format date9./*          ,L4_Next_Review_Date as Next_Rvw_Dte*/            ,Extract_Date/*              length 8*//*              format date9.*/            ,GRP_LMT            ,GRP_USG            ,GRP_EXP            ,WBC_PD            ,GRP_RVW_FLG/*          ,LMU_Manager*/            ,CR_Manager            ,Watchlist/*          ,L4_Overdue_Flag as Overdue*/            ,calcOverDue_Flag as Overdue            ,Commercial_Exposure            ,Retail_Exposure            ,Secondary_Watchlist            ,SRC_APPL        ,CIGS        ,CIGS_Outcome_Combo/*      ,"Review Reason Code= " || L4a_Node_ID as Primary_Review_Reason */        ,catx(" - ",L4a_Node_ID, L4a_Node_Description) as  Primary_Review_Reason        ,L4_Recent_BLAST_Incr_L6M as Recent_BLAST_Incr_L6M        ,L4_Recent_BLAST_Rev_L12M as Recent_BLAST_Rev_L12M/*      ,GB_Reviews_Flag*//*      ,strSource*//*      ,L2a_Reviewable_Flag*//*      ,Source_FB01*//*      ,Source_FB02*//*      ,Source_FB03*//*      ,Source_FB04*//*      ,Source_FB05*//*      ,L3_Node_ID_Desc *//*      ,L3_Outcome*//*      ,L3_Report_SME_Flag *//*      ,L3_Report_Comm_Flag *//*      ,L3_ReportKeep_Flag *//*      ,ActionTrail*//*      ,GBC_Flag*/      from COMMON.STG_ORFull_ListRptFB_&MK.     );quit;libname XL clear;proc freq data = COMMON.STG_ORFull_ListRptFB_&MK.;    table L4a_Node_ID / nocol norow nopercent;    where SEGMENT = "Asset Finance";quit;proc sql;   create table COMMON.STG_ORFull_ListRptFB_&MK.x as     (select catx(" - ",L4a_Node_ID, L4a_Node_Description)  as  Primary_Review_Reason      from COMMON.STG_ORFull_ListRptFB_&MK.     );quit;proc freq data = COMMON.STG_ORFull_ListRptFB_&MK.x;    table Primary_Review_Reason  / nocol norow nopercent;quit;/*CIGS=Z:*/libname XL EXCEL "c:\ar\output\SBG_CIGS_Z_&MK..xlsb";proc datasets lib = XL nolist;    Delete Data;quit;data XL.Data;    set COMMON.SBG_AR_FinOutREVIEW_&MK.L4az;run;libname XL clear;/**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*Monitoring Report:*//*Before/After:*/%let BeforeFile = COMMON.SBG_AR_CMS_RFL_&MK.;%let AfterFile = COMMON.SBG_AR_FinOutREVIEW_&MK.L4a;%let PublishedFile = COMMON.SBG_AR_Published;/*&ExtractFN.;*/proc contents    data = &BeforeFile.    out = COMMON.zASFR_Contents_Before    noprint    ;quit;proc contents    data = &AfterFile.    out = COMMON.zASFR_Contents_After    noprint    ;quit;libname XL EXCEL "c:\ar\output\SCODR001 - CMS Overdue Reviews_&MK._CIGSFBL4.xls";data COMMON.SBG_AR_Published;    set XL.ORFL;run;libname XL clear;proc contents    data = &PublishedFile.    out = COMMON.zASFR_Contents_Published    noprint    ;quit;/*Populate a new Excel worksheet from SAS.*/libname XL EXCEL "c:\ar\output\ASFR_Process_Contents.xlsb";/*---*/proc datasets lib = XL nolist;    Delete Contents_Before;quit;data XL.Contents_Before;    set COMMON.zASFR_Contents_Before;run;/*---*/proc datasets lib = XL nolist;    Delete Contents_After;quit;data XL.Contents_After;    set COMMON.zASFR_Contents_After;run;/*---*/proc datasets lib = XL nolist;    Delete Contents_Published;quit;data XL.Contents_Published;    set COMMON.zASFR_Contents_Published;run;libname XL clear;/*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*Compare:*/sasfile &BeforeFile. load;sasfile &PublishedFile. load;sasfile &AfterFile. load;data COMMON.SBG_AR_Monitor_Main;    Merge        &BeforeFile. (in=inBefore keep =                        GEOGRAPHY                        REGION                        SEGMENT                        BCH_NAME                        Extract_Date                        Next_Rvw_Dte                        GRP_RVW_FLG                        Group_ID                        rename = (                            GEOGRAPHY = b_GEOGRAPHY                            REGION = b_REGION                            SEGMENT = b_SEGMENT                            BCH_NAME = b_BCH_NAME                            Extract_Date = b_Extract_Date                            Next_Rvw_Dte = b_Next_Rvw_Dte                            GRP_RVW_FLG = b_GRP_RVW_FLG                                )                        )        &PublishedFile. (in=inPubl keep =                        GEOGRAPHY                        REGION                        SEGMENT                        BCH_NAME                        Extract_Date                        Next_Rvw_Dte                        GRP_RVW_FLG                        CUST_GRP_ID                        rename = (                                CUST_GRP_ID = Group_ID                                GEOGRAPHY = p_GEOGRAPHY                                REGION = p_REGION                                SEGMENT = p_SEGMENT                                BCH_NAME = p_BCH_NAME                                Extract_Date = p_Extract_Date                                Next_Rvw_Dte = p_Next_Rvw_Dte                                GRP_RVW_FLG = p_GRP_RVW_FLG                                )                        )        &AfterFile. (in=inAfter keep =                        GEOGRAPHY                        REGION                        SEGMENT                        BCH_NAME                        Extract_Date                        Next_Rvw_Dte                        GRP_RVW_FLG                        Group_ID                        CIGS                        CIGS_Outcome_Combo                        Commercial_Exposure                        ManRevReason_Combo                        BusTCE_LT250k_Flag                        L4_Recent_BLAST_Incr_L6M                        L4_Recent_BLAST_Rev_L12M                        L4a_Node_ID                        L4a_Reportable_Flag                        L4a_Node_Description                        calcNext_Review_Date                        NewAdds_Flag                        HistCarryOver_Flag                        Num_DaysGrace                        calcOverDue_Flag                        rename = (                                GEOGRAPHY = a_GEOGRAPHY                                REGION = a_REGION                                SEGMENT = a_SEGMENT                                BCH_NAME = a_BCH_NAME                                Extract_Date = a_Extract_Date                                Next_Rvw_Dte = a_Next_Rvw_Dte                                GRP_RVW_FLG = a_GRP_RVW_FLG                                )                        )        ;    by GROUP_ID;    Format        Source $200.        Before_Flag $1.        After_Flag $1.        Publish_Flag $1.        ;    Source = "x";    Before_Flag = "N";    After_Flag = "N";    Publish_Flag = "N";    if inBefore then do;        Source = catx("\", Source, "01. Before");        Before_Flag = "y";    end;    if inAfter then do;        Source = catx("\", Source, "02. After");        After_Flag = "Y";    end;    if inPubl then do;        Source = catx("\", Source, "03. Publ");        Publish_Flag = "Y";    end;    /* Compare Before and After/Publish */    Format        Changed_GEOGRAPHY $1.        Changed_REGION $1.        Changed_SEGMENT $1.        Changed_BCH_NAME $1.        Changed_Extract_Date $1.        Changed_Next_Rvw_Dte $1.        Changed_GRP_RVW_FLG $1.        ;    Changed_GEOGRAPHY = "N";    Changed_REGION = "N";    Changed_SEGMENT = "N";    Changed_BCH_NAME = "N";    Changed_Extract_Date = "N";    Changed_Next_Rvw_Dte = "N";    Changed_GRP_RVW_FLG = "N";    if Publish_Flag = "Y" then do;        if b_GEOGRAPHY ne p_GEOGRAPHY then do; Changed_GEOGRAPHY = "Y";end;        if b_REGION ne p_REGION then do; Changed_REGION = "Y";end;        if b_SEGMENT ne p_SEGMENT then do; Changed_SEGMENT = "Y";end;        if b_BCH_NAME ne p_BCH_NAME then do; Changed_BCH_NAME = "Y";end;        if b_Extract_Date ne p_Extract_Date then do; Changed_Extract_Date = "Y";end;        if b_Next_Rvw_Dte ne p_Next_Rvw_Dte then do; Changed_Next_Rvw_Dte = "Y";end;        if b_GRP_RVW_FLG ne p_GRP_RVW_FLG then do; Changed_GRP_RVW_FLG = "Y";end;    end;    else do;        if b_GEOGRAPHY ne a_GEOGRAPHY then do; Changed_GEOGRAPHY = "Y"; end;        if b_REGION ne a_REGION then do; Changed_REGION = "Y"; end;        if b_SEGMENT ne a_SEGMENT then do; Changed_SEGMENT = "Y"; end;        if b_BCH_NAME ne a_BCH_NAME then do; Changed_BCH_NAME = "Y"; end;        if b_Extract_Date ne a_Extract_Date then do; Changed_Extract_Date = "Y"; end;        if b_Next_Rvw_Dte ne a_Next_Rvw_Dte then do; Changed_Next_Rvw_Dte = "Y"; end;        if b_GRP_RVW_FLG ne a_GRP_RVW_FLG then do; Changed_GRP_RVW_FLG = "Y"; end;    end;    Format        Count 8#        ;    Count = 1;run;sasfile &BeforeFile. close;sasfile &PublishedFile. close;sasfile &AfterFile. close;proc freq data = COMMON.SBG_AR_Monitor_Main;    table Source / nocol norow nopercent;quit;proc means    Data = COMMON.SBG_AR_Monitor_Main    noprint    nway    missing    ;    class        Source        Before_Flag        After_Flag        Publish_Flag        Changed_GEOGRAPHY        Changed_REGION        Changed_SEGMENT        Changed_BCH_NAME        Changed_Extract_Date        Changed_Next_Rvw_Dte        Changed_GRP_RVW_FLGb_GEOGRAPHY a_GEOGRAPHY p_GEOGRAPHYb_REGION    a_REGION    p_REGIONb_SEGMENT   a_SEGMENT   p_SEGMENTb_BCH_NAME  a_BCH_NAME  p_BCH_NAMEb_Extract_Date  a_Extract_Date  p_Extract_Dateb_Next_Rvw_Dte  a_Next_Rvw_Dte  p_Next_Rvw_Dteb_GRP_RVW_FLG   a_GRP_RVW_FLG   p_GRP_RVW_FLGL4a_Node_IDL4a_Reportable_FlagL4a_Node_DescriptioncalcNext_Review_DateNewAdds_FlagHistCarryOver_Flag      ;    Var        Count        ;    output        out = COMMON.SBG_AR_Monitor_Maino (drop = _TYPE_ _FREQ_)        Sum = Count        ;run;libname XL EXCEL "c:\ar\output\SBG_AR_Monitor_Main_Report.xlsb";proc datasets lib = XL nolist;    delete Data;quit;data XL.Data;    set COMMON.SBG_AR_Monitor_Maino;run;libname XL clear;/**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*Simplified version of Reportability:          *//*Hist file:                                    */    /*if RevL12m = "Y"                          */    /*or IncrL6M = "Y"                          */    /*then                                      */    /*  Remove from hist file.                  *//*Report file:                                  */    /*if "M"                                    */    /*  then                                    */    /*      OnReport                            */    /*      Date from report                    */    /*else                                      */    /*  if "A"                                  */    /*  and CIGS = "N"                          */    /*  and RevL12m = "N"                       */    /*  and incrL6M = "N"                       */    /*  then                                    */    /*      OnReport                            */    /*      if added this month                 */    /*          Date = +3                       */    /*          add to hist file                */    /*      else                                */    /*          Date = from hist file           */    /*  else                                    */    /*      Not_OnReport                        */    /*------------------------------------------*//*Month 0 = 201605:*/%put ---- s001 ----;%let MK = 201605;%let HistM0 = May2016;/*All in A table:*/proc sql;   create table COMMON.SBG_AR_CMS_RFL_&MK._o1 as     (select             a.*            ,b.CIGS_Combo            ,b.CIGS_Outcome_Combo            ,b.CIGS_Node_ID_Combo            ,b.CIGS_Flag            ,c.L4_Recent_BLAST_Incr_L6M            ,d.L4_Recent_BLAST_Rev_L12M            ,e.ManualReview_Flag            ,e.ManRevReason_GT10m            ,e.ManRevReason_INVDISC            ,e.ManRevReason_MAF            ,e.ManRevReason_Combo            ,f.Bus_TCE            ,f.BusTCE_LT250k_Flag            ,g.L4a_Node_ID            ,g.L4a_Reportable_Flag      from COMMON.SBG_AR_CMS_RFL_&MK. a      /* CIGS */      left outer join COMMON.SBG_AR_RCMS_G2_&MK. b      on a.Group_ID = b.Group_ID      /* BLAST: recent lending */      left outer join COMMON.SBG_ARincr_BLAST_&MK.d c      on a.Group_ID = c.Group_ID      /* BLAST: recent review */      left outer join COMMON.SBG_ARrev_BLAST_&MK.b d      on a.Group_ID = d.Group_ID      /* Manual review candidates */      left outer join COMMON.SBG_AR_ManualReviews_&MK. e      on a.Group_ID = e.Group_ID            /* BusTCE */      left outer join COMMON.SBG_AR_BusTCE_&MK. f      on a.Group_ID = f.Group_ID           /* Node ID */     left outer join COMMON.SBG_AR_FinOutREVIEW_&MK.L4a (keep =                        Group_ID                        L4a_Node_ID                        L4a_Reportable_Flag                        ) g     on a.Group_ID = g.Group_ID     );quit;/*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o1;*//*  table GRP_RVW_FLG * CIGS_Flag  / nocol norow nopercent missing;*//*quit;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o1;*//*  table ManRevReason_Combo * ManualReview_Flag  / nocol norow nopercent missing;*//*quit;*//**//*             *//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o1;*//*  table L4a_Node_ID * L4a_Reportable_Flag  / nocol norow nopercent missing;*//*quit;*/             %put ---- s002 ----;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o1 load;Data    /* ADDs: */    /* Auto; CIGS = N: */    COMMON.SBG_AR_CMS_RFL_&MK._o2an    /* LEAVE OFFs: */    /* Auto; CIGS = Y: */    COMMON.SBG_AR_CMS_RFL_&MK._o2ay    /* KEEPs */    /* Manual: */    COMMON.SBG_AR_CMS_RFL_&MK._o2m        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* Manual */    if GRP_RVW_FLG ne "A"        and        GRP_RVW_FLG ne "" then do;        output COMMON.SBG_AR_CMS_RFL_&MK._o2m;    end;    /* Auto, CIGS "N": */    if CIGS_Flag = "N"     and GRP_RVW_FLG = "A"     then do;        Next_Rvw_Dte = INTNX("MONTH", input("&MK.", ? yymmn6.), 4 ) - 1;        output COMMON.SBG_AR_CMS_RFL_&MK._o2an;     end;     /* Auto, CIGS "Y": */    if CIGS_Flag = "Y"     and GRP_RVW_FLG = "A"     then do;        output COMMON.SBG_AR_CMS_RFL_&MK._o2ay;     end;run;/* Exception Report: Null CIGS: */Data    COMMON.SBG_AR_CMS_RFL_&MK._o2z        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* CIGS = null */    if CIGS_Flag = "" then do;        output COMMON.SBG_AR_CMS_RFL_&MK._o2z;    end;run;/* Exception Report: Manual review candidates, flagged as "A": */Data    COMMON.SBG_AR_CMS_RFL_&MK._o2man        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* Manuals, set with Auto flag */    if GRP_RVW_FLG = "A"        and        ManualReview_Flag = "Y"        then do;            output COMMON.SBG_AR_CMS_RFL_&MK._o2man;    end;run;/* Exception Report: Group Review Flag not set: */Data    COMMON.SBG_AR_CMS_RFL_&MK._o2ngrf        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* Manuals, set with Auto flag */    if GRP_RVW_FLG = ""        then do;            output COMMON.SBG_AR_CMS_RFL_&MK._o2ngrf;    end;run;/* Recent BLASTs: */Data    COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* Recent BLASTs: */    if        L4_Recent_BLAST_Incr_L6M gt 0        or        L4_Recent_BLAST_Rev_L12M gt 0        ;run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o1 close;/*proc print *//*    data = COMMON.SBG_AR_CMS_RFL_&MK._o2an (obs=5)*//*        ;*//*run;*//*---*/%put ---- s003 ----;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2an load;data COMMON.SBG_AR_CMS_RFL_&MK._o2anrem;    set COMMON.SBG_AR_CMS_RFL_&MK._o2an;    /* big amounts */    if Commercial_Exposure > 250000;    /* no recent BLASTs */    if        L4_Recent_BLAST_Incr_L6M eq .        and        L4_Recent_BLAST_Rev_L12M eq .        ;    Format        Month_Key $6.        ;    Month_Key = "&MK.";run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2an close;/*proc print *//*    data = COMMON.SBG_AR_CMS_RFL_&MK._o2anrem (obs=5)*//*        ;*//*run;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o2anrem;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o2m;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*Create History: month 0:*//*One-off step for this stream:*/proc sql;   create table COMMON.SBG_M0_&HistM0._o2hist like COMMON.SBG_AR_CMS_RFL_&MK._o2anrem;quit;/*Update the history file:*/proc append    data = COMMON.SBG_AR_CMS_RFL_&MK._o2anrem    out  = COMMON.SBG_M0_&HistM0._o2hist    ;    where L4a_Reportable_Flag = "Y";run;%put ---- s004 ----;/*History: clean up of recent BLASTs - remove them:*/proc sql;   create table COMMON.SBG_M0_&HistM0._o2CLN as     (select a.*      from COMMON.SBG_M0_&HistM0._o2hist a      left outer join COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST b      on a.Group_ID = b.Group_ID      where b.Group_ID Is Null     );quit;/*Build the file:*//*Manuals*//*+ Auto with CIGS "N" which have not been removed:*/%put ---- s005 ----;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2anrem load;sasfile COMMON.SBG_M0_&HistM0._o2CLN load;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2m load;data COMMON.SBG_AR_CMS_RFL_&MK._o3;    Merge        COMMON.SBG_AR_CMS_RFL_&MK._o2anrem (in=inA)        COMMON.SBG_M0_&HistM0._o2CLN (in=inB                            rename = (                                    Next_Rvw_Dte = Hist_Next_Rvw_Dte                                    ))        COMMON.SBG_AR_CMS_RFL_&MK._o2m (in=inC)        ;    by Group_ID;            if inB then do;            Next_Rvw_Dte = Hist_Next_Rvw_Dte;        end;        Format            Source $5.            ;        Source = "";        if inA then Source = catx("\",Source,"A");        if inB then Source = catx("\",Source,"H");        if inC then Source = catx("\",Source,"M");        /* Overdue flag */        /*Overdue calc:*/        /*if */        /*  Auto review flag*/        /*,Watchlist,*/        /*,<=E35*/        /*          = 1 day*/        /*Manual review flag */        /*          = 45 days' grace*/        Overdue = "";        if            GRP_RVW_FLG = "A"            or            UpCase(Watchlist) = "YES"            or            UpCase(Secondary_Watchlist) = "YES"            or            substr(WBC_PD, 1, 1) in ("E","F","G","H")                then do;            if Next_Rvw_Dte + 1 < input("&MK.", ? yymmn6.) then do;                Overdue = "YES";            end;        end;        if            GRP_RVW_FLG ne "A"                then do;            if Next_Rvw_Dte + 45 < input("&MK.", ? yymmn6.) then do;                Overdue = "YES";            end;        end;run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2anrem close;sasfile COMMON.SBG_M0_&HistM0._o2CLN close;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2m close;/*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Watchlist / nocol norow nopercent missing;*//*  table Secondary_Watchlist / nocol norow nopercent missing;*//*quit;*//**//*proc print *//*    data = COMMON.SBG_AR_CMS_RFL_&MK._o3 (obs=5)*//*        ;*//*run;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Source / nocol norow nopercent;*//*quit;*//**//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Overdue / nocol norow nopercent missing;*//*  where GRP_RVW_FLG = "A";*//*quit;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Overdue / nocol norow nopercent missing;*//*  where GRP_RVW_FLG ne "A";*//*quit;*/%put ---- s006 ----;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o3 load;data COMMON.SBG_AR_CMS_RFL_&MK._o4;    set COMMON.SBG_AR_CMS_RFL_&MK._o3;    if L4a_Reportable_Flag = "Y";run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o3 close;/*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*Month 1 with Month 0 = May-2016:*/%let MK = 201606;/*All in A table:*/%put ---- s007 ----;proc sql;   create table COMMON.SBG_AR_CMS_RFL_&MK._o1 as     (select             a.*            ,b.CIGS_Combo            ,b.CIGS_Outcome_Combo            ,b.CIGS_Node_ID_Combo            ,b.CIGS_Flag            ,c.L4_Recent_BLAST_Incr_L6M            ,d.L4_Recent_BLAST_Rev_L12M            ,e.ManualReview_Flag            ,e.ManRevReason_GT10m            ,e.ManRevReason_INVDISC            ,e.ManRevReason_MAF            ,e.ManRevReason_Combo            ,f.Bus_TCE            ,f.BusTCE_LT250k_Flag            ,g.L4a_Node_ID            ,g.L4a_Reportable_Flag      from COMMON.SBG_AR_CMS_RFL_&MK. a      /* CIGS */      left outer join COMMON.SBG_AR_RCMS_G2_&MK. b      on a.Group_ID = b.Group_ID      /* BLAST: recent lending */      left outer join COMMON.SBG_ARincr_BLAST_&MK.d c      on a.Group_ID = c.Group_ID      /* BLAST: recent review */      left outer join COMMON.SBG_ARrev_BLAST_&MK.b d      on a.Group_ID = d.Group_ID      /* Manual review candidates */      left outer join COMMON.SBG_AR_ManualReviews_&MK. e      on a.Group_ID = e.Group_ID            /* BusTCE */      left outer join COMMON.SBG_AR_BusTCE_&MK. f      on a.Group_ID = f.Group_ID           /* Node ID */     left outer join COMMON.SBG_AR_FinOutREVIEW_&MK.L4a (keep =                        Group_ID                        L4a_Node_ID                        L4a_Reportable_Flag                        ) g     on a.Group_ID = g.Group_ID     );quit;/*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o1;*//*  table GRP_RVW_FLG * CIGS_Flag  / nocol norow nopercent missing;*//*quit;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o1;*//*  table ManRevReason_Combo * ManualReview_Flag  / nocol norow nopercent missing;*//*quit;*/                          %put ---- s008 ----;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o1 load;Data    /* ADDs: */    /* Auto; CIGS = N: */    COMMON.SBG_AR_CMS_RFL_&MK._o2an    /* LEAVE OFFs: */    /* Auto; CIGS = Y: */    COMMON.SBG_AR_CMS_RFL_&MK._o2ay    /* KEEPs */    /* Manual: */    COMMON.SBG_AR_CMS_RFL_&MK._o2m        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* Manual */    if GRP_RVW_FLG ne "A"        and        GRP_RVW_FLG ne "" then do;        output COMMON.SBG_AR_CMS_RFL_&MK._o2m;    end;    /* Auto, CIGS "N": */    if CIGS_Flag = "N"     and GRP_RVW_FLG = "A"     then do;        Next_Rvw_Dte = INTNX("MONTH", input("&MK.", ? yymmn6.), 4 ) - 1;        output COMMON.SBG_AR_CMS_RFL_&MK._o2an;     end;     /* Auto, CIGS "Y": */    if CIGS_Flag = "Y"     and GRP_RVW_FLG = "A"     then do;        output COMMON.SBG_AR_CMS_RFL_&MK._o2ay;     end;run;/* Exception Report: Null CIGS: */Data    COMMON.SBG_AR_CMS_RFL_&MK._o2z        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* CIGS = null */    if CIGS_Flag = "" then do;        output COMMON.SBG_AR_CMS_RFL_&MK._o2z;    end;run;/* Exception Report: Manual review candidates, flagged as "A": */Data    COMMON.SBG_AR_CMS_RFL_&MK._o2man        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* Manuals, set with Auto flag */    if GRP_RVW_FLG = "A"        and        ManualReview_Flag = "Y"        then do;            output COMMON.SBG_AR_CMS_RFL_&MK._o2man;    end;run;/* Exception Report: Group Review Flag not set: */Data    COMMON.SBG_AR_CMS_RFL_&MK._o2ngrf        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* Manuals, set with Auto flag */    if GRP_RVW_FLG = ""        then do;            output COMMON.SBG_AR_CMS_RFL_&MK._o2ngrf;    end;run;/* Recent BLASTs: */Data    COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* Recent BLASTs: */    if        L4_Recent_BLAST_Incr_L6M gt 0        or        L4_Recent_BLAST_Rev_L12M gt 0        ;run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o1 close;/*proc print *//*    data = COMMON.SBG_AR_CMS_RFL_&MK._o2an (obs=5)*//*        ;*//*run;*//*---*/%put ---- s009 ----;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2an load;data COMMON.SBG_AR_CMS_RFL_&MK._o2anrem;    set COMMON.SBG_AR_CMS_RFL_&MK._o2an;    /* big amounts */    if Commercial_Exposure > 250000;    /* no recent BLASTs */    if        L4_Recent_BLAST_Incr_L6M eq .        and        L4_Recent_BLAST_Rev_L12M eq .        ;    Format        Month_Key $6.        ;    Month_Key = "&MK.";run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2an close;/*proc print *//*    data = COMMON.SBG_AR_CMS_RFL_&MK._o2anrem (obs=5)*//*        ;*//*run;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o2anrem;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o2m;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*Create History: month 0:*//*One-off step for this stream:*//*proc sql;*//*   create table COMMON.SBG_AR_m0_May2016_o2hist like COMMON.SBG_AR_CMS_RFL_&MK._o2anrem*//*;*//*quit;*//*Update the history file:*/proc append    data = COMMON.SBG_AR_CMS_RFL_&MK._o2anrem    out  = COMMON.SBG_M0_&HistM0._o2hist    ;    where L4a_Reportable_Flag = "Y";run;/*History: clean up of recent BLASTs - remove them:*//*sasfile COMMON.SBG_AR_m0_May2016_o2hist load;*//*sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST load;*//*data COMMON.SBG_AR_CMS_RFL_&MK._o2RD;*//*  merge*//*      COMMON.SBG_AR_m0_May2016_o2hist (in=inHist)*//*      COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST (in=RBLAST*//*                  rename = (*//*                      L4_Recent_BLAST_Incr_L6M = L4_Recent_BLAST_Incr*//*                      L4_Recent_BLAST_Rev_L12M = L4_Recent_BLAST_Rev*//*                          )*//*                      )*//*      ;*//*  by Group_ID;*//*  if inHist;*//*  if L4_Recent_BLAST_Incr > 0*//*      or *//*      L4_Recent_BLAST_Rev*//*      ;*//*run;*//*sasfile COMMON.SBG_AR_m0_May2016_o2hist close;*//*sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST close;*/%put ---- s010 ----;proc sql;   create table COMMON.SBG_M0_&HistM0._o2CLN as     (select a.*      from COMMON.SBG_M0_&HistM0._o2hist a      left outer join COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST (                    rename = (                        L4_Recent_BLAST_Incr_L6M = L4_Recent_BLAST_Incr                        L4_Recent_BLAST_Rev_L12M = L4_Recent_BLAST_Rev                            )                        ) b      on a.Group_ID = b.Group_ID/*    where b.Group_ID is null*/      where        b.L4_Recent_BLAST_Incr eq .        and        b.L4_Recent_BLAST_Rev eq .     );quit;/*Build the file:*//*Manuals*//*+ Auto with CIGS "N" which have not been removed:*/%put ---- s011 ----;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2anrem load;sasfile COMMON.SBG_M0_&HistM0._o2CLN load;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2m load;data COMMON.SBG_AR_CMS_RFL_&MK._o3;    Merge        COMMON.SBG_AR_CMS_RFL_&MK._o2anrem (in=inA)        COMMON.SBG_M0_&HistM0._o2CLN (in=inB                            rename = (                                    Next_Rvw_Dte = Hist_Next_Rvw_Dte                                    ))        COMMON.SBG_AR_CMS_RFL_&MK._o2m (in=inC)        ;    by Group_ID;            if inB then do;            Next_Rvw_Dte = Hist_Next_Rvw_Dte;        end;        Format            Source $5.            ;        Source = "";        if inA then Source = catx("\",Source,"A");        if inB then Source = catx("\",Source,"H");        if inC then Source = catx("\",Source,"M");        /* Overdue flag */        /*Overdue calc:*/        /*if */        /*  Auto review flag*/        /*,Watchlist,*/        /*,<=E35*/        /*          = 1 day*/        /*Manual review flag */        /*          = 45 days' grace*/        Overdue = "";        if            GRP_RVW_FLG = "A"            or            UpCase(Watchlist) = "YES"            or            UpCase(Secondary_Watchlist) = "YES"            or            substr(WBC_PD, 1, 1) in ("E","F","G","H")                then do;            if Next_Rvw_Dte + 1 < input("&MK.", ? yymmn6.) then do;                Overdue = "YES";            end;        end;        if            GRP_RVW_FLG ne "A"                then do;            if Next_Rvw_Dte + 45 < input("&MK.", ? yymmn6.) then do;                Overdue = "YES";            end;        end;run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2anrem close;sasfile COMMON.SBG_M0_&HistM0._o2CLN close;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2m close;/*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Watchlist / nocol norow nopercent missing;*//*  table Secondary_Watchlist / nocol norow nopercent missing;*//*quit;*//**//*proc print *//*    data = COMMON.SBG_AR_CMS_RFL_&MK._o3 (obs=5)*//*        ;*//*run;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Source / nocol norow nopercent;*//*quit;*//**//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Overdue / nocol norow nopercent missing;*//*  where GRP_RVW_FLG = "A";*//*quit;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Overdue / nocol norow nopercent missing;*//*  where GRP_RVW_FLG ne "A";*//*quit;*/%put ---- s012 ----;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o3 load;data COMMON.SBG_AR_CMS_RFL_&MK._o4;    set COMMON.SBG_AR_CMS_RFL_&MK._o3;    if L4a_Reportable_Flag = "Y";run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o3 close;/*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*Month 1 with Month 0 = May-2016:*/%let MK = 201607;/*All in A table:*/proc sql;   create table COMMON.SBG_AR_CMS_RFL_&MK._o1 as     (select             a.*            ,b.CIGS_Combo            ,b.CIGS_Outcome_Combo            ,b.CIGS_Node_ID_Combo            ,b.CIGS_Flag            ,c.L4_Recent_BLAST_Incr_L6M            ,d.L4_Recent_BLAST_Rev_L12M            ,e.ManualReview_Flag            ,e.ManRevReason_GT10m            ,e.ManRevReason_INVDISC            ,e.ManRevReason_MAF            ,e.ManRevReason_Combo            ,f.Bus_TCE            ,f.BusTCE_LT250k_Flag            ,g.L4a_Node_ID            ,g.L4a_Reportable_Flag      from COMMON.SBG_AR_CMS_RFL_&MK. a      /* CIGS */      left outer join COMMON.SBG_AR_RCMS_G2_&MK. b      on a.Group_ID = b.Group_ID      /* BLAST: recent lending */      left outer join COMMON.SBG_ARincr_BLAST_&MK.d c      on a.Group_ID = c.Group_ID      /* BLAST: recent review */      left outer join COMMON.SBG_ARrev_BLAST_&MK.b d      on a.Group_ID = d.Group_ID      /* Manual review candidates */      left outer join COMMON.SBG_AR_ManualReviews_&MK. e      on a.Group_ID = e.Group_ID            /* BusTCE */      left outer join COMMON.SBG_AR_BusTCE_&MK. f      on a.Group_ID = f.Group_ID           /* Node ID */     left outer join COMMON.SBG_AR_FinOutREVIEW_&MK.L4a (keep =                        Group_ID                        L4a_Node_ID                        L4a_Reportable_Flag                        ) g     on a.Group_ID = g.Group_ID     );quit;/*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o1;*//*  table GRP_RVW_FLG * CIGS_Flag  / nocol norow nopercent missing;*//*quit;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o1;*//*  table ManRevReason_Combo * ManualReview_Flag  / nocol norow nopercent missing;*//*quit;*/                          sasfile COMMON.SBG_AR_CMS_RFL_&MK._o1 load;Data    /* ADDs: */    /* Auto; CIGS = N: */    COMMON.SBG_AR_CMS_RFL_&MK._o2an    /* LEAVE OFFs: */    /* Auto; CIGS = Y: */    COMMON.SBG_AR_CMS_RFL_&MK._o2ay    /* KEEPs */    /* Manual: */    COMMON.SBG_AR_CMS_RFL_&MK._o2m        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* Manual */    if GRP_RVW_FLG ne "A"        and        GRP_RVW_FLG ne "" then do;        output COMMON.SBG_AR_CMS_RFL_&MK._o2m;    end;    /* Auto, CIGS "N": */    if CIGS_Flag = "N"     and GRP_RVW_FLG = "A"     then do;        Next_Rvw_Dte = INTNX("MONTH", input("&MK.", ? yymmn6.), 4 ) - 1;        output COMMON.SBG_AR_CMS_RFL_&MK._o2an;     end;     /* Auto, CIGS "Y": */    if CIGS_Flag = "Y"     and GRP_RVW_FLG = "A"     then do;        output COMMON.SBG_AR_CMS_RFL_&MK._o2ay;     end;run;/* Exception Report: Null CIGS: */Data    COMMON.SBG_AR_CMS_RFL_&MK._o2z        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* CIGS = null */    if CIGS_Flag = "" then do;        output COMMON.SBG_AR_CMS_RFL_&MK._o2z;    end;run;/* Exception Report: Manual review candidates, flagged as "A": */Data    COMMON.SBG_AR_CMS_RFL_&MK._o2man        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* Manuals, set with Auto flag */    if GRP_RVW_FLG = "A"        and        ManualReview_Flag = "Y"        then do;            output COMMON.SBG_AR_CMS_RFL_&MK._o2man;    end;run;/* Exception Report: Group Review Flag not set: */Data    COMMON.SBG_AR_CMS_RFL_&MK._o2ngrf        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* Manuals, set with Auto flag */    if GRP_RVW_FLG = ""        then do;            output COMMON.SBG_AR_CMS_RFL_&MK._o2ngrf;    end;run;/* Recent BLASTs: */Data    COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST        ;    set COMMON.SBG_AR_CMS_RFL_&MK._o1;    /* Recent BLASTs: */    if        L4_Recent_BLAST_Incr_L6M gt 0        or        L4_Recent_BLAST_Rev_L12M gt 0        ;run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o1 close;/*proc print *//*    data = COMMON.SBG_AR_CMS_RFL_&MK._o2an (obs=5)*//*        ;*//*run;*//*---*/sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2an load;data COMMON.SBG_AR_CMS_RFL_&MK._o2anrem;    set COMMON.SBG_AR_CMS_RFL_&MK._o2an;    /* big amounts */    if Commercial_Exposure > 250000;    /* no recent BLASTs */    if        L4_Recent_BLAST_Incr_L6M eq .        and        L4_Recent_BLAST_Rev_L12M eq .        ;    Format        Month_Key $6.        ;    Month_Key = "&MK.";run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2an close;/*proc print *//*    data = COMMON.SBG_AR_CMS_RFL_&MK._o2anrem (obs=5)*//*        ;*//*run;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o2anrem;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o2m;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*Create History: month 0:*//*One-off step for this stream:*//*proc sql;*//*   create table COMMON.SBG_AR_m0_May2016_o2hist like COMMON.SBG_AR_CMS_RFL_&MK._o2anrem*//*;*//*quit;*//*Update the history file:*/proc append    data = COMMON.SBG_AR_CMS_RFL_&MK._o2anrem    out  = COMMON.SBG_M0_&HistM0._o2hist    ;    where L4a_Reportable_Flag = "Y";run;/*History: clean up of recent BLASTs - remove them:*//*sasfile COMMON.SBG_AR_m0_May2016_o2hist load;*//*sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST load;*//*data COMMON.SBG_AR_CMS_RFL_&MK._o2RD;*//*  merge*//*      COMMON.SBG_AR_m0_May2016_o2hist (in=inHist)*//*      COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST (in=RBLAST*//*                  rename = (*//*                      L4_Recent_BLAST_Incr_L6M = L4_Recent_BLAST_Incr*//*                      L4_Recent_BLAST_Rev_L12M = L4_Recent_BLAST_Rev*//*                          )*//*                      )*//*      ;*//*  by Group_ID;*//*  if inHist;*//*  if L4_Recent_BLAST_Incr > 0*//*      or *//*      L4_Recent_BLAST_Rev*//*      ;*//*run;*//*sasfile COMMON.SBG_AR_m0_May2016_o2hist close;*//*sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST close;*/proc sql;   create table COMMON.SBG_M0_&HistM0._o2CLN as     (select a.*      from COMMON.SBG_M0_&HistM0._o2hist a      left outer join COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST (                    rename = (                        L4_Recent_BLAST_Incr_L6M = L4_Recent_BLAST_Incr                        L4_Recent_BLAST_Rev_L12M = L4_Recent_BLAST_Rev                            )                        ) b      on a.Group_ID = b.Group_ID/*    where b.Group_ID is null*/      where        b.L4_Recent_BLAST_Incr eq .        and        b.L4_Recent_BLAST_Rev eq .     );quit;/*Build the file:*//*Manuals*//*+ Auto with CIGS "N" which have not been removed:*/sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2anrem load;sasfile COMMON.SBG_M0_&HistM0._o2CLN load;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2m load;data COMMON.SBG_AR_CMS_RFL_&MK._o3;    Merge        COMMON.SBG_AR_CMS_RFL_&MK._o2anrem (in=inA)        COMMON.SBG_M0_&HistM0._o2CLN (in=inB                            rename = (                                    Next_Rvw_Dte = Hist_Next_Rvw_Dte                                    ))        COMMON.SBG_AR_CMS_RFL_&MK._o2m (in=inC)        ;    by Group_ID;            if inB then do;            Next_Rvw_Dte = Hist_Next_Rvw_Dte;        end;        Format            Source $5.            ;        Source = "";        if inA then Source = catx("\",Source,"A");        if inB then Source = catx("\",Source,"H");        if inC then Source = catx("\",Source,"M");        /* Overdue flag */        /*Overdue calc:*/        /*if */        /*  Auto review flag*/        /*,Watchlist,*/        /*,<=E35*/        /*          = 1 day*/        /*Manual review flag */        /*          = 45 days' grace*/        Overdue = "";        if            GRP_RVW_FLG = "A"            or            UpCase(Watchlist) = "YES"            or            UpCase(Secondary_Watchlist) = "YES"            or            substr(WBC_PD, 1, 1) in ("E","F","G","H")                then do;            if Next_Rvw_Dte + 1 < input("&MK.", ? yymmn6.) then do;                Overdue = "YES";            end;        end;        if            GRP_RVW_FLG ne "A"                then do;            if Next_Rvw_Dte + 45 < input("&MK.", ? yymmn6.) then do;                Overdue = "YES";            end;        end;run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2anrem close;sasfile COMMON.SBG_M0_&HistM0._o2CLN close;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2m close;/*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Watchlist / nocol norow nopercent missing;*//*  table Secondary_Watchlist / nocol norow nopercent missing;*//*quit;*//**//*proc print *//*    data = COMMON.SBG_AR_CMS_RFL_&MK._o3 (obs=5)*//*        ;*//*run;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Source / nocol norow nopercent;*//*quit;*//**//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Overdue / nocol norow nopercent missing;*//*  where GRP_RVW_FLG = "A";*//*quit;*//*proc freq data = COMMON.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Overdue / nocol norow nopercent missing;*//*  where GRP_RVW_FLG ne "A";*//*quit;*/sasfile COMMON.SBG_AR_CMS_RFL_&MK._o3 load;data COMMON.SBG_AR_CMS_RFL_&MK._o4;    set COMMON.SBG_AR_CMS_RFL_&MK._o3;    if L4a_Reportable_Flag = "Y";run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o3 close;/**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*Month 0 = Jun-2016:*/%let NS = s1;%let HistM0 = Jun2016;/*Month 1 with Month 0 = May-2016:*/%let MK = 201606;/*All in A table:*/proc sql;   create table COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1 as     (select             a.*            ,b.CIGS_Combo            ,b.CIGS_Outcome_Combo            ,b.CIGS_Node_ID_Combo            ,b.CIGS_Flag            ,c.L4_Recent_BLAST_Incr_L6M            ,d.L4_Recent_BLAST_Rev_L12M            ,e.ManualReview_Flag            ,e.ManRevReason_GT10m            ,e.ManRevReason_INVDISC            ,e.ManRevReason_MAF            ,e.ManRevReason_Combo            ,f.Bus_TCE            ,f.BusTCE_LT250k_Flag            ,g.L4a_Node_ID            ,g.L4a_Reportable_Flag      from COMMON.SBG_AR_CMS_RFL_&MK. a      /* CIGS */      left outer join COMMON.SBG_AR_RCMS_G2_&MK. b      on a.Group_ID = b.Group_ID      /* BLAST: recent lending */      left outer join COMMON.SBG_ARincr_BLAST_&MK.d c      on a.Group_ID = c.Group_ID      /* BLAST: recent review */      left outer join COMMON.SBG_ARrev_BLAST_&MK.b d      on a.Group_ID = d.Group_ID      /* Manual review candidates */      left outer join COMMON.SBG_AR_ManualReviews_&MK. e      on a.Group_ID = e.Group_ID            /* BusTCE */      left outer join COMMON.SBG_AR_BusTCE_&MK. f      on a.Group_ID = f.Group_ID           /* Node ID */     left outer join COMMON.SBG_AR_FinOutREVIEW_&MK.L4a (keep =                        Group_ID                        L4a_Node_ID                        L4a_Reportable_Flag                        ) g     on a.Group_ID = g.Group_ID     );quit;/*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;*//*  table GRP_RVW_FLG * CIGS_Flag  / nocol norow nopercent missing;*//*quit;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;*//*  table ManRevReason_Combo * ManualReview_Flag  / nocol norow nopercent missing;*//*quit;*/                          sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1 load;Data    /* ADDs: */    /* Auto; CIGS = N: */    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an    /* LEAVE OFFs: */    /* Auto; CIGS = Y: */    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2ay    /* KEEPs */    /* Manual: */    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* Manual */    if GRP_RVW_FLG ne "A"        and        GRP_RVW_FLG ne "" then do;        output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m;    end;    /* Auto, CIGS "N": */    if CIGS_Flag = "N"     and GRP_RVW_FLG = "A"     then do;        Next_Rvw_Dte = INTNX("MONTH", input("&MK.", ? yymmn6.), 4 ) - 1;        output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an;     end;     /* Auto, CIGS "Y": */    if CIGS_Flag = "Y"     and GRP_RVW_FLG = "A"     then do;        output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2ay;     end;run;/* Exception Report: Null CIGS: */Data    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2z        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* CIGS = null */    if CIGS_Flag = "" then do;        output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2z;    end;run;/* Exception Report: Manual review candidates, flagged as "A": */Data    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2man        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* Manuals, set with Auto flag */    if GRP_RVW_FLG = "A"        and        ManualReview_Flag = "Y"        then do;            output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2man;    end;run;/* Exception Report: Group Review Flag not set: */Data    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2ngrf        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* Manuals, set with Auto flag */    if GRP_RVW_FLG = ""        then do;            output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2ngrf;    end;run;/* Recent BLASTs: */Data    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2RBLST        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* Recent BLASTs: */    if        L4_Recent_BLAST_Incr_L6M gt 0        or        L4_Recent_BLAST_Rev_L12M gt 0        ;run;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1 close;/*proc print *//*    data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an (obs=5)*//*        ;*//*run;*//*---*/sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an load;data COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an;    /* big amounts */    if Commercial_Exposure > 250000;    /* no recent BLASTs */    if        L4_Recent_BLAST_Incr_L6M eq .        and        L4_Recent_BLAST_Rev_L12M eq .        ;    Format        Month_Key $6.        ;    Month_Key = "&MK.";run;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an close;/*proc print *//*    data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem (obs=5)*//*        ;*//*run;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*Create History: month 0:*//*One-off step for this stream:*/proc sql;   create table COMMON.&NS.SBG_m0_&HistM0._o2hist like COMMON.SBG_AR_CMS_RFL_&MK._o2anrem;quit;/*Update the history file:*/proc append    data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem    out  = COMMON.&NS.SBG_m0_&HistM0._o2hist    ;    where L4a_Reportable_Flag = "Y";run;/*History: clean up of recent BLASTs - remove them:*//*sasfile COMMON.SBG_AR_m0_May2016_o2hist load;*//*sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST load;*//*data COMMON.SBG_AR_CMS_RFL_&MK._o2RD;*//*  merge*//*      COMMON.SBG_AR_m0_May2016_o2hist (in=inHist)*//*      COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST (in=RBLAST*//*                  rename = (*//*                      L4_Recent_BLAST_Incr_L6M = L4_Recent_BLAST_Incr*//*                      L4_Recent_BLAST_Rev_L12M = L4_Recent_BLAST_Rev*//*                          )*//*                      )*//*      ;*//*  by Group_ID;*//*  if inHist;*//*  if L4_Recent_BLAST_Incr > 0*//*      or *//*      L4_Recent_BLAST_Rev*//*      ;*//*run;*//*sasfile COMMON.SBG_AR_m0_May2016_o2hist close;*//*sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST close;*/proc sql;   create table COMMON.&NS.SBG_M0_&HistM0._o2CLN as     (select a.*      from COMMON.&NS.SBG_m0_&HistM0._o2hist a      left outer join COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2RBLST (                    rename = (                        L4_Recent_BLAST_Incr_L6M = L4_Recent_BLAST_Incr                        L4_Recent_BLAST_Rev_L12M = L4_Recent_BLAST_Rev                            )                        ) b      on a.Group_ID = b.Group_ID/*    where b.Group_ID is null*/      where        b.L4_Recent_BLAST_Incr eq .        and        b.L4_Recent_BLAST_Rev eq .     );quit;/*Build the file:*//*Manuals*//*+ Auto with CIGS "N" which have not been removed:*/sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem load;sasfile COMMON.&NS.SBG_M0_&HistM0._o2CLN load;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m load;data COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;    Merge        COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem (in=inA)        COMMON.&NS.SBG_M0_&HistM0._o2CLN (in=inB                            rename = (                                    Next_Rvw_Dte = Hist_Next_Rvw_Dte                                    ))        COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m (in=inC)        ;    by Group_ID;            if inB then do;            Next_Rvw_Dte = Hist_Next_Rvw_Dte;        end;        Format            Source $5.            ;        Source = "";        if inA then Source = catx("\",Source,"A");        if inB then Source = catx("\",Source,"H");        if inC then Source = catx("\",Source,"M");        /* Overdue flag */        /*Overdue calc:*/        /*if */        /*  Auto review flag*/        /*,Watchlist,*/        /*,<=E35*/        /*          = 1 day*/        /*Manual review flag */        /*          = 45 days' grace*/        Overdue = "";        if            GRP_RVW_FLG = "A"            or            UpCase(Watchlist) = "YES"            or            UpCase(Secondary_Watchlist) = "YES"            or            substr(WBC_PD, 1, 1) in ("E","F","G","H")                then do;            if Next_Rvw_Dte + 1 < input("&MK.", ? yymmn6.) then do;                Overdue = "YES";            end;        end;        if            GRP_RVW_FLG ne "A"                then do;            if Next_Rvw_Dte + 45 < input("&MK.", ? yymmn6.) then do;                Overdue = "YES";            end;        end;run;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem close;sasfile COMMON.&NS.SBG_M0_&HistM0._o2CLN close;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m close;/*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Watchlist / nocol norow nopercent missing;*//*  table Secondary_Watchlist / nocol norow nopercent missing;*//*quit;*//**//*proc print *//*    data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3 (obs=5)*//*        ;*//*run;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Source / nocol norow nopercent;*//*quit;*//**//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Overdue / nocol norow nopercent missing;*//*  where GRP_RVW_FLG = "A";*//*quit;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Overdue / nocol norow nopercent missing;*//*  where GRP_RVW_FLG ne "A";*//*quit;*/sasfile COMMON.SBG_AR_CMS_RFL_&MK._o3 load;data COMMON.SBG_AR_CMS_RFL_&MK._o4;    set COMMON.SBG_AR_CMS_RFL_&MK._o3;    if L4a_Reportable_Flag = "Y";run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o3 close;/*        <=== End of code section. ===>        *//*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*Month 2 with Month 0 = Jun-2016:*/%let MK = 201607;/*All in A table:*/proc sql;   create table COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1 as     (select             a.*            ,b.CIGS_Combo            ,b.CIGS_Outcome_Combo            ,b.CIGS_Node_ID_Combo            ,b.CIGS_Flag            ,c.L4_Recent_BLAST_Incr_L6M            ,d.L4_Recent_BLAST_Rev_L12M            ,e.ManualReview_Flag            ,e.ManRevReason_GT10m            ,e.ManRevReason_INVDISC            ,e.ManRevReason_MAF            ,e.ManRevReason_Combo            ,f.Bus_TCE            ,f.BusTCE_LT250k_Flag            ,g.L4a_Node_ID            ,g.L4a_Reportable_Flag      from COMMON.SBG_AR_CMS_RFL_&MK. a      /* CIGS */      left outer join COMMON.SBG_AR_RCMS_G2_&MK. b      on a.Group_ID = b.Group_ID      /* BLAST: recent lending */      left outer join COMMON.SBG_ARincr_BLAST_&MK.d c      on a.Group_ID = c.Group_ID      /* BLAST: recent review */      left outer join COMMON.SBG_ARrev_BLAST_&MK.b d      on a.Group_ID = d.Group_ID      /* Manual review candidates */      left outer join COMMON.SBG_AR_ManualReviews_&MK. e      on a.Group_ID = e.Group_ID            /* BusTCE */      left outer join COMMON.SBG_AR_BusTCE_&MK. f      on a.Group_ID = f.Group_ID           /* Node ID */     left outer join COMMON.SBG_AR_FinOutREVIEW_&MK.L4a (keep =                        Group_ID                        L4a_Node_ID                        L4a_Reportable_Flag                        ) g     on a.Group_ID = g.Group_ID     );quit;/*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;*//*  table GRP_RVW_FLG * CIGS_Flag  / nocol norow nopercent missing;*//*quit;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;*//*  table ManRevReason_Combo * ManualReview_Flag  / nocol norow nopercent missing;*//*quit;*/                          sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1 load;Data    /* ADDs: */    /* Auto; CIGS = N: */    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an    /* LEAVE OFFs: */    /* Auto; CIGS = Y: */    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2ay    /* KEEPs     */    /* Manual: */    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* Manual */    if GRP_RVW_FLG ne "A"        and        GRP_RVW_FLG ne "" then do;        output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m;    end;    /* Auto, CIGS "N": */    if CIGS_Flag = "N"     and GRP_RVW_FLG = "A"     then do;        Next_Rvw_Dte = INTNX("MONTH", input("&MK.", ? yymmn6.), 4 ) - 1;        output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an;     end;     /* Auto, CIGS "Y": */    if CIGS_Flag = "Y"     and GRP_RVW_FLG = "A"     then do;        output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2ay;     end;run;/* Exception Report: Null CIGS: */Data    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2z        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* CIGS = null */    if CIGS_Flag = "" then do;        output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2z;    end;run;/* Exception Report: Manual review candidates, flagged as "A": */Data    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2man        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* Manuals, set with Auto flag */    if GRP_RVW_FLG = "A"        and        ManualReview_Flag = "Y"        then do;            output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2man;    end;run;/* Exception Report: Group Review Flag not set: */Data    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2ngrf        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* Manuals, set with Auto flag */    if GRP_RVW_FLG = ""        then do;            output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2ngrf;    end;run;/* Recent BLASTs: */Data    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2RBLST        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* Recent BLASTs: */    if        L4_Recent_BLAST_Incr_L6M gt 0        or        L4_Recent_BLAST_Rev_L12M gt 0        ;run;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1 close;/*proc print *//*    data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an (obs=5)*//*        ;*//*run;*//*---*/sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an load;data COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an;    /* big amounts */    if Commercial_Exposure > 250000;    /* no recent BLASTs */    if        L4_Recent_BLAST_Incr_L6M eq .        and        L4_Recent_BLAST_Rev_L12M eq .        ;    Format        Month_Key $6.        ;    Month_Key = "&MK.";run;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an close;/*proc print *//*    data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem (obs=5)*//*        ;*//*run;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*Create History: month 0:*//*One-off step for this stream:*//*proc sql;*//*   create table COMMON.SBG_AR_m0_May2016_o2hist like COMMON.SBG_AR_CMS_RFL_&MK._o2anrem*//*;*//*quit;*//*Update the history file:*/proc append    data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem    out  = COMMON.&NS.SBG_m0_&HistM0._o2hist    ;    where L4a_Reportable_Flag = "Y";run;    /*History: clean up of recent BLASTs - remove them:*//*sasfile COMMON.SBG_AR_m0_May2016_o2hist load;*//*sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST load;*//*data COMMON.SBG_AR_CMS_RFL_&MK._o2RD;*//*  merge*//*      COMMON.SBG_AR_m0_May2016_o2hist (in=inHist)*//*      COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST (in=RBLAST*//*                  rename = (*//*                      L4_Recent_BLAST_Incr_L6M = L4_Recent_BLAST_Incr*//*                      L4_Recent_BLAST_Rev_L12M = L4_Recent_BLAST_Rev*//*                          )*//*                      )*//*      ;*//*  by Group_ID;*//*  if inHist;*//*  if L4_Recent_BLAST_Incr > 0*//*      or *//*      L4_Recent_BLAST_Rev*//*      ;*//*run;*//*sasfile COMMON.SBG_AR_m0_May2016_o2hist close;*//*sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST close;*/proc sql;   create table COMMON.&NS.SBG_M0_&HistM0._o2CLN as     (select a.*      from COMMON.&NS.SBG_m0_&HistM0._o2hist a      left outer join COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2RBLST (                    rename = (                        L4_Recent_BLAST_Incr_L6M = L4_Recent_BLAST_Incr                        L4_Recent_BLAST_Rev_L12M = L4_Recent_BLAST_Rev                            )                        ) b      on a.Group_ID = b.Group_ID/*    where b.Group_ID is null*/      where        b.L4_Recent_BLAST_Incr eq .        and        b.L4_Recent_BLAST_Rev eq .     );quit;/*Build the file:*//*Manuals*//*+ Auto with CIGS "N" which have not been removed:*/sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem load;sasfile COMMON.&NS.SBG_M0_&HistM0._o2CLN load;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m load;data COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;    Merge        COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem (in=inA)        COMMON.&NS.SBG_M0_&HistM0._o2CLN (in=inB                            rename = (                                    Next_Rvw_Dte = Hist_Next_Rvw_Dte                                    ))        COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m (in=inC)        ;    by Group_ID;            if inB then do;            Next_Rvw_Dte = Hist_Next_Rvw_Dte;        end;        Format            Source $5.            ;        Source = "";        if inA then Source = catx("\",Source,"A");        if inB then Source = catx("\",Source,"H");        if inC then Source = catx("\",Source,"M");        /* Overdue flag */        /*Overdue calc:*/        /*if */        /*  Auto review flag*/        /*,Watchlist,*/        /*,<=E35*/        /*          = 1 day*/        /*Manual review flag */        /*          = 45 days' grace*/        Overdue = "";        if            GRP_RVW_FLG = "A"            or            UpCase(Watchlist) = "YES"            or            UpCase(Secondary_Watchlist) = "YES"            or            substr(WBC_PD, 1, 1) in ("E","F","G","H")                then do;            if Next_Rvw_Dte + 1 < input("&MK.", ? yymmn6.) then do;                Overdue = "YES";            end;        end;        if            GRP_RVW_FLG ne "A"                then do;            if Next_Rvw_Dte + 45 < input("&MK.", ? yymmn6.) then do;                Overdue = "YES";            end;        end;run;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem close;sasfile COMMON.&NS.SBG_M0_&HistM0._o2CLN close;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m close;/*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Watchlist / nocol norow nopercent missing;*//*  table Secondary_Watchlist / nocol norow nopercent missing;*//*quit;*//**//*proc print *//*    data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3 (obs=5)*//*        ;*//*run;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Source / nocol norow nopercent;*//*quit;*//**//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Overdue / nocol norow nopercent missing;*//*  where GRP_RVW_FLG = "A";*//*quit;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Overdue / nocol norow nopercent missing;*//*  where GRP_RVW_FLG ne "A";*//*quit;*/sasfile COMMON.SBG_AR_CMS_RFL_&MK._o3 load;data COMMON.SBG_AR_CMS_RFL_&MK._o4;    set COMMON.SBG_AR_CMS_RFL_&MK._o3;    if L4a_Reportable_Flag = "Y";run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o3 close;/**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*                                                                       *//*                                                                       *//*       SSSSSS TTTTTTTTTTT   EEEEEEEEEE   PPPPPPPPP                     *//*      SSS         TT        EEE          PP      PP                    *//*      SS          TT        EE           PP     PP                     *//*        SSSS      TT        EEEEEEE      PPPPPPPP                      *//*           SS     TT        EEE          PP                            *//*           SS     TT        EE           PP                            *//*           SS     TT        EE           PP                            *//*      SSSSSS      TT        EEEEEEEEEE   PP                            *//*                                                                       *//*                                                                       *//**** ~~~~~~~~~~~~ oooooooooooooooo OOO oooooooooooooooo ~~~~~~~~~~~~ ****//*Month 0 = Jul-2016:*/%let NS = s2;%let HistM0 = Jul2016;%let MK = 201607;/*All in A table:*/proc sql;   create table COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1 as     (select             a.*            ,b.CIGS_Combo            ,b.CIGS_Outcome_Combo            ,b.CIGS_Node_ID_Combo            ,b.CIGS_Flag            ,c.L4_Recent_BLAST_Incr_L6M            ,d.L4_Recent_BLAST_Rev_L12M            ,e.ManualReview_Flag            ,e.ManRevReason_GT10m            ,e.ManRevReason_INVDISC            ,e.ManRevReason_MAF            ,e.ManRevReason_Combo            ,f.Bus_TCE            ,f.BusTCE_LT250k_Flag            ,g.L4a_Node_ID            ,g.L4a_Reportable_Flag      from COMMON.SBG_AR_CMS_RFL_&MK. a      /* CIGS */      left outer join COMMON.SBG_AR_RCMS_G2_&MK. b      on a.Group_ID = b.Group_ID      /* BLAST: recent lending */      left outer join COMMON.SBG_ARincr_BLAST_&MK.d c      on a.Group_ID = c.Group_ID      /* BLAST: recent review */      left outer join COMMON.SBG_ARrev_BLAST_&MK.b d      on a.Group_ID = d.Group_ID      /* Manual review candidates */      left outer join COMMON.SBG_AR_ManualReviews_&MK. e      on a.Group_ID = e.Group_ID            /* BusTCE */      left outer join COMMON.SBG_AR_BusTCE_&MK. f      on a.Group_ID = f.Group_ID           /* Node ID */     left outer join COMMON.SBG_AR_FinOutREVIEW_&MK.L4a (keep =                        Group_ID                        L4a_Node_ID                        L4a_Reportable_Flag                        ) g     on a.Group_ID = g.Group_ID     );quit;/*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;*//*  table GRP_RVW_FLG * CIGS_Flag  / nocol norow nopercent missing;*//*quit;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;*//*  table ManRevReason_Combo * ManualReview_Flag  / nocol norow nopercent missing;*//*quit;*/                          sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1 load;Data    /* ADDs: */    /* Auto; CIGS = N: */    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an    /* LEAVE OFFs: */    /* Auto; CIGS = Y: */    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2ay    /* KEEPs */    /* Manual: */    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* Manual */    if GRP_RVW_FLG ne "A"        and        GRP_RVW_FLG ne "" then do;        output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m;    end;    /* Auto, CIGS "N": */    if CIGS_Flag = "N"     and GRP_RVW_FLG = "A"     then do;        Next_Rvw_Dte = INTNX("MONTH", input("&MK.", ? yymmn6.), 4 ) - 1;        output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an;     end;     /* Auto, CIGS "Y": */    if CIGS_Flag = "Y"     and GRP_RVW_FLG = "A"     then do;        output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2ay;     end;run;/* Exception Report: Null CIGS: */Data    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2z        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* CIGS = null */    if CIGS_Flag = "" then do;        output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2z;    end;run;/* Exception Report: Manual review candidates, flagged as "A": */Data    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2man        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* Manuals, set with Auto flag */    if GRP_RVW_FLG = "A"        and        ManualReview_Flag = "Y"        then do;            output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2man;    end;run;/* Exception Report: Group Review Flag not set: */Data    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2ngrf        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* Manuals, set with Auto flag */    if GRP_RVW_FLG = ""        then do;            output COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2ngrf;    end;run;/* Recent BLASTs: */Data    COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2RBLST        ;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1;    /* Recent BLASTs: */    if        L4_Recent_BLAST_Incr_L6M gt 0        or        L4_Recent_BLAST_Rev_L12M gt 0        ;run;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o1 close;/*proc print *//*    data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an (obs=5)*//*        ;*//*run;*//*---*/sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an load;data COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an;    /* big amounts */    if Commercial_Exposure > 250000;    /* no recent BLASTs */    if        L4_Recent_BLAST_Incr_L6M eq .        and        L4_Recent_BLAST_Rev_L12M eq .        ;    Format        Month_Key $6.        ;    Month_Key = "&MK.";run;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2an close;/*proc print *//*    data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem (obs=5)*//*        ;*//*run;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*Create History: month 0:*//*One-off step for this stream:*/proc sql;   create table COMMON.&NS.SBG_m0_&HistM0._o2hist like COMMON.SBG_AR_CMS_RFL_&MK._o2anrem;quit;/*Update the history file:*/proc append    data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem    out  = COMMON.&NS.SBG_m0_&HistM0._o2hist    ;    where L4a_Reportable_Flag = "Y";run;/*History: clean up of recent BLASTs - remove them:*//*sasfile COMMON.SBG_AR_m0_May2016_o2hist load;*//*sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST load;*//*data COMMON.SBG_AR_CMS_RFL_&MK._o2RD;*//*  merge*//*      COMMON.SBG_AR_m0_May2016_o2hist (in=inHist)*//*      COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST (in=RBLAST*//*                  rename = (*//*                      L4_Recent_BLAST_Incr_L6M = L4_Recent_BLAST_Incr*//*                      L4_Recent_BLAST_Rev_L12M = L4_Recent_BLAST_Rev*//*                          )*//*                      )*//*      ;*//*  by Group_ID;*//*  if inHist;*//*  if L4_Recent_BLAST_Incr > 0*//*      or *//*      L4_Recent_BLAST_Rev*//*      ;*//*run;*//*sasfile COMMON.SBG_AR_m0_May2016_o2hist close;*//*sasfile COMMON.SBG_AR_CMS_RFL_&MK._o2RBLST close;*/proc sql;   create table COMMON.&NS.SBG_M0_&HistM0._o2CLN as     (select a.*      from COMMON.&NS.SBG_m0_&HistM0._o2hist a      left outer join COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2RBLST (                    rename = (                        L4_Recent_BLAST_Incr_L6M = L4_Recent_BLAST_Incr                        L4_Recent_BLAST_Rev_L12M = L4_Recent_BLAST_Rev                            )                        ) b      on a.Group_ID = b.Group_ID/*    where b.Group_ID is null*/      where        b.L4_Recent_BLAST_Incr eq .        and        b.L4_Recent_BLAST_Rev eq .     );quit;/*Build the file:*//*Manuals*//*+ Auto with CIGS "N" which have not been removed:*/sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem load;sasfile COMMON.&NS.SBG_M0_&HistM0._o2CLN load;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m load;data COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;    Merge        COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem (in=inA)        COMMON.&NS.SBG_M0_&HistM0._o2CLN (in=inB                            rename = (                                    Next_Rvw_Dte = Hist_Next_Rvw_Dte                                    ))        COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m (in=inC)        ;    by Group_ID;            if inB then do;            Next_Rvw_Dte = Hist_Next_Rvw_Dte;        end;        Format            Source $5.            ;        Source = "";        if inA then Source = catx("\",Source,"A");        if inB then Source = catx("\",Source,"H");        if inC then Source = catx("\",Source,"M");        /* Overdue flag */        /*Overdue calc:*/        /*if */        /*  Auto review flag*/        /*,Watchlist,*/        /*,<=E35*/        /*          = 1 day*/        /*Manual review flag */        /*          = 45 days' grace*/        Overdue = "";        if            GRP_RVW_FLG = "A"            or            UpCase(Watchlist) = "YES"            or            UpCase(Secondary_Watchlist) = "YES"            or            substr(WBC_PD, 1, 1) in ("E","F","G","H")                then do;            if Next_Rvw_Dte + 1 < input("&MK.", ? yymmn6.) then do;                Overdue = "YES";            end;        end;        if            GRP_RVW_FLG ne "A"                then do;            if Next_Rvw_Dte + 45 < input("&MK.", ? yymmn6.) then do;                Overdue = "YES";            end;        end;run;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem close;sasfile COMMON.&NS.SBG_M0_&HistM0._o2CLN close;sasfile COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m close;/*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Watchlist / nocol norow nopercent missing;*//*  table Secondary_Watchlist / nocol norow nopercent missing;*//*quit;*//**//*proc print *//*    data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3 (obs=5)*//*        ;*//*run;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * GRP_RVW_FLG / nocol norow nopercent;*//*quit;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Source / nocol norow nopercent;*//*quit;*//**//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Overdue / nocol norow nopercent missing;*//*  where GRP_RVW_FLG = "A";*//*quit;*//*proc freq data = COMMON.&NS.SBG_AR_CMS_RFL_&MK._o3;*//*  table Next_Rvw_Dte * Overdue / nocol norow nopercent missing;*//*  where GRP_RVW_FLG ne "A";*//*quit;*/sasfile COMMON.SBG_AR_CMS_RFL_&MK._o3 load;data COMMON.SBG_AR_CMS_RFL_&MK._o4;    set COMMON.SBG_AR_CMS_RFL_&MK._o3;    if L4a_Reportable_Flag = "Y";run;sasfile COMMON.SBG_AR_CMS_RFL_&MK._o3 close;/*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*-----------------------------------------------------------------------------------*//*Output:*//*Populate a new Excel worksheet from SAS.*/%let NS =;%let MK = 201605;%let MNum = 1;%let HistM0 = May2016;libname XL EXCEL "c:\ar\output\SBG_AR_M0_&HistM0..xlsb";proc datasets lib = XL nolist;    Delete FullFileM&MNum.;quit;data XL.FullFileM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o4;run;proc datasets lib = XL nolist;    Delete AutoOutputM&MNum.;quit;data XL.AutoOutputM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem;run;proc datasets lib = XL nolist;    Delete Hist_Before_M&MNum.;quit;data XL.Hist_Before_M&MNum.;    set COMMON.&NS.SBG_M0_&HistM0._o2hist;run;proc datasets lib = XL nolist;    Delete Hist_After_M&MNum.;quit;data XL.Hist_After_M&MNum.;    set COMMON.&NS.SBG_M0_&HistM0._o2CLN;run; proc datasets lib = XL nolist;    Delete ManualM&MNum.;quit;data XL.ManualM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m;run;proc datasets lib = XL nolist;    Delete RecentBLASTM&MNum.;quit;data XL.RecentBLASTM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2RBLST;run;/*---*/%let MK = 201606;%let MNum = 2;proc datasets lib = XL nolist;    Delete FullFileM&MNum.;quit;data XL.FullFileM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o4;run;proc datasets lib = XL nolist;    Delete AutoOutputM&MNum.;quit;data XL.AutoOutputM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem;run;proc datasets lib = XL nolist;    Delete Hist_Before_M&MNum.;quit;data XL.Hist_Before_M&MNum.;    set COMMON.&NS.SBG_M0_&HistM0._o2hist;run;proc datasets lib = XL nolist;    Delete Hist_After_M&MNum.;quit;data XL.Hist_After_M&MNum.;    set COMMON.&NS.SBG_M0_&HistM0._o2CLN;run; proc datasets lib = XL nolist;    Delete ManualM&MNum.;quit;data XL.ManualM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m;run;proc datasets lib = XL nolist;    Delete RecentBLASTM&MNum.;quit;data XL.RecentBLASTM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2RBLST;run;/*---*/%let MK = 201607;%let MNum = 3;proc datasets lib = XL nolist;    Delete FullFileM&MNum.;quit;data XL.FullFileM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o4;run;proc datasets lib = XL nolist;    Delete AutoOutputM&MNum.;quit;data XL.AutoOutputM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem;run;proc datasets lib = XL nolist;    Delete Hist_Before_M&MNum.;quit;data XL.Hist_Before_M&MNum.;    set COMMON.&NS.SBG_M0_&HistM0._o2hist;run;proc datasets lib = XL nolist;    Delete Hist_After_M&MNum.;quit;data XL.Hist_After_M&MNum.;    set COMMON.&NS.SBG_M0_&HIstM0._o2CLN;run; proc datasets lib = XL nolist;    Delete ManualM&MNum.;quit;data XL.ManualM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m;run;proc datasets lib = XL nolist;    Delete RecentBLASTM&MNum.;quit;data XL.RecentBLASTM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2RBLST;run;libname XL clear;/*Stream 1:*/%let NS = s1;%let MK = 201606;%let HistM0 = Jun2016;%let MNum = 1;libname XL EXCEL "c:\ar\output\SBG_AR_M0_&HistM0..xlsb";proc datasets lib = XL nolist;    Delete FullFileM&MNum.;quit;data XL.FullFileM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o4;run;proc datasets lib = XL nolist;    Delete AutoOutputM&MNum.;quit;data XL.AutoOutputM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem;run;proc datasets lib = XL nolist;    Delete Hist_Before_M&MNum.;quit;data XL.Hist_Before_M&MNum.;    set COMMON.&NS.SBG_M0_&HistM0._o2hist;run;proc datasets lib = XL nolist;    Delete Hist_After_M&MNum.;quit;data XL.Hist_After_M&MNum.;    set COMMON.&NS.SBG_M0_&HistM0._o2CLN;run; proc datasets lib = XL nolist;    Delete ManualM&MNum.;quit;data XL.ManualM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m;run;proc datasets lib = XL nolist;    Delete RecentBLASTM&MNum.;quit;data XL.RecentBLASTM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2RBLST;run;/*---*/%let MK = 201607;%let MNum = 2;proc datasets lib = XL nolist;    Delete FullFileM&MNum.;quit;data XL.FullFileM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o4;run;proc datasets lib = XL nolist;    Delete AutoOutputM&MNum.;quit;data XL.AutoOutputM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem;run;proc datasets lib = XL nolist;    Delete Hist_Before_M&MNum.;quit;data XL.Hist_Before_M&MNum.;    set COMMON.&NS.SBG_M0_&HistM0._o2hist;run;proc datasets lib = XL nolist;    Delete Hist_After_M&MNum.;quit;data XL.Hist_After_M&MNum.;    set COMMON.&NS.SBG_M0_&HistM0._o2CLN;run; proc datasets lib = XL nolist;    Delete ManualM&MNum.;quit;data XL.ManualM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m;run;proc datasets lib = XL nolist;    Delete RecentBLASTM&MNum.;quit;data XL.RecentBLASTM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2RBLST;run;libname XL clear;/*Stream 2:*/%let NS = s2;%let MK = 201607;%let HistM0 = Jul2016;%let MNum = 1;libname XL EXCEL "c:\ar\output\SBG_AR_M0_&HistM0..xlsb";proc datasets lib = XL nolist;    Delete FullFileM&MNum.;quit;data XL.FullFileM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o4;run;proc datasets lib = XL nolist;    Delete AutoOutputM&MNum.;quit;data XL.AutoOutputM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2anrem;run;proc datasets lib = XL nolist;    Delete Hist_Before_M&MNum.;quit;data XL.Hist_Before_M&MNum.;    set COMMON.&NS.SBG_M0_&HistM0._o2hist;run;proc datasets lib = XL nolist;    Delete Hist_After_M&MNum.;quit;data XL.Hist_After_M&MNum.;    set COMMON.&NS.SBG_M0_&HistM0._o2CLN;run; proc datasets lib = XL nolist;    Delete ManualM&MNum.;quit;data XL.ManualM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2m;run;proc datasets lib = XL nolist;    Delete RecentBLASTM&MNum.;quit;data XL.RecentBLASTM&MNum.;    set COMMON.&NS.SBG_AR_CMS_RFL_&MK._o2RBLST;run;libname XL clear;
